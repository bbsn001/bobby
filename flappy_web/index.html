<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Bobby Bird</title>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%; height: 100%;
      background: #0a0a2e;
      font-family: Arial, sans-serif;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    canvas {
      display: block; touch-action: none; user-select: none;
      will-change: transform; transform: translateZ(0);
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }

    /* â”€â”€ Shared screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .screen {
      position: fixed; inset: 0;
      background: #0a0a2e;
      display: flex; flex-direction: column; align-items: center;
      overflow-y: auto; -webkit-overflow-scrolling: touch;
      z-index: 100;
    }
    .screen-inner {
      width: 100%; max-width: 500px;
      padding: 32px 20px;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100%;
      justify-content: center;
    }
    .screen-title  { color: #ffd700; font-size: 2.2em; font-weight: bold; margin-bottom: 6px; text-align: center; }
    .screen-sub    { color: #aaa; font-size: .88rem; margin-bottom: 24px; text-align: center; }

    /* â”€â”€ Inputs / Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .big-input {
      width: 80%; max-width: 280px; height: 58px;
      font-size: 16px; padding: 0 16px; text-align: center;
      border: 2px solid #ffd700; border-radius: 10px;
      background: #0f1432; color: #fff; outline: none;
      margin-bottom: 14px;
    }
    .big-input.error { border-color: #dc3232; }
    .btn {
      display: flex; align-items: center; justify-content: center;
      width: 80%; max-width: 280px; height: 56px;
      font-size: 1.1rem; font-weight: bold;
      border: none; border-radius: 10px; cursor: pointer;
      touch-action: manipulation; margin-bottom: 10px;
      transition: filter .12s;
    }
    .btn:active { filter: brightness(.82); }
    .btn-yellow { background: #ffd700; color: #0f1432; }
    .btn-blue   { background: #1a6aff; color: #fff; }
    .btn-dark   { background: #1e1e4a; color: #aaa; border: 1px solid #333; }
    .btn-sm     { height: 40px; font-size: .88rem; width: auto; padding: 0 18px; margin-bottom: 0; }

    /* â”€â”€ Coins badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .coins { color: #ffd700; font-size: 1.05rem; margin-bottom: 16px; }

    /* â”€â”€ Character preview (lobby) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .char-preview {
      display: flex; align-items: center; gap: 12px;
      background: #131340; border: 1px solid #2a2a6a;
      border-radius: 12px; padding: 10px 14px;
      margin-bottom: 20px; width: 80%; max-width: 280px;
    }
    .char-preview img { width: 48px; height: 48px; object-fit: cover; border-radius: 8px; background: #0f1432; }
    .cp-name  { color: #fff; font-weight: bold; font-size: .9rem; }
    .cp-bonus { color: #8be; font-size: .72rem; margin-top: 2px; }

    /* â”€â”€ Shop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .shop-header {
      display: flex; justify-content: space-between; align-items: center;
      width: 100%; margin-bottom: 18px;
    }
    .shop-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px; width: 100%;
    }
    @media (min-width: 460px) { .shop-grid { grid-template-columns: repeat(3, 1fr); } }

    .char-card {
      background: #131340; border: 2px solid #2a2a6a;
      border-radius: 12px; padding: 10px 8px 10px;
      display: flex; flex-direction: column; align-items: center; gap: 5px;
      position: relative;
    }
    .char-card.active-card { border-color: #22b422; }
    .char-card.majka-card  { border-color: #ffd700; box-shadow: 0 0 14px #ffd70055; }
    .char-card img {
      width: 68px; height: 68px; object-fit: cover;
      border-radius: 8px; background: #0f1432;
    }
    .cc-name    { color: #fff; font-weight: bold; font-size: .85rem; text-align: center; }
    .cc-bonuses { color: #8be; font-size: .62rem; text-align: center; line-height: 1.35; min-height: 26px; }
    .cc-btn {
      width: 100%; height: 34px;
      font-size: .78rem; font-weight: bold;
      border: none; border-radius: 7px; cursor: pointer;
      touch-action: manipulation; margin-top: 2px;
    }
    .cc-btn.active  { background: #22b422; color: #fff; }
    .cc-btn.select  { background: #1a6aff; color: #fff; }
    .cc-btn.buy     { background: #ffd700; color: #0f1432; }
    .cc-btn.locked  { background: #1e1e4a; color: #444; cursor: default; }

    /* â”€â”€ Char picker (lobby) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #charPicker { scrollbar-width: none; }
    #charPicker::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>

<!-- â”€â”€ Nick screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="nickScreen" class="screen">
  <div class="screen-inner">
    <div class="screen-title">&#x1F426; Bobby Bird</div>
    <div class="screen-sub">Wpisz nick, Å¼eby graÄ‡</div>
    <input id="nickInput" class="big-input" type="text" maxlength="16"
      placeholder="TwÃ³j nick"
      autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
    <button id="nickConfirm" class="btn btn-yellow">DALEJ â†’</button>
  </div>
</div>

<!-- â”€â”€ Lobby screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="lobbyScreen" class="screen" style="display:none">
  <div class="screen-inner">
    <div class="screen-title" style="font-size:1.55em;margin-bottom:2px">Bobby Bird</div>
    <div id="lobbyNick" style="color:#aaa;font-size:.85rem;margin-bottom:10px"></div>
    <div id="lobbyCoins" class="coins">ğŸµ 0 coinÃ³w</div>

    <div id="charPreview" class="char-preview">
      <img id="charPreviewImg" src="" alt="" />
      <div>
        <div id="charPreviewName" class="cp-name">Bobby</div>
        <div id="charPreviewBonus" class="cp-bonus">brak bonusÃ³w</div>
      </div>
    </div>

    <!-- Horizontal character picker -->
    <div id="charPicker"
      style="display:flex;overflow-x:auto;gap:8px;padding:4px 2px;
             width:100%;max-width:280px;margin-bottom:18px;
             -webkit-overflow-scrolling:touch">
    </div>

    <button id="lobbyPlay" class="btn btn-yellow">â–¶ GRAJ</button>
    <button id="lobbyShop" class="btn btn-blue">ğŸ›’ SKLEP</button>
  </div>
</div>

<!-- â”€â”€ Shop screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="shopScreen" class="screen" style="display:none">
  <div class="screen-inner" style="justify-content:flex-start;padding-top:20px">
    <div class="shop-header">
      <button id="shopBack" class="btn btn-dark btn-sm">â† WRÃ“Ä†</button>
      <div id="shopCoins" class="coins" style="margin:0">ğŸµ 0</div>
    </div>
    <div id="shopGrid" class="shop-grid"></div>
  </div>
</div>

<!-- â”€â”€ DOM HUD overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="hud" style="position:fixed;top:0;left:0;width:100%;pointer-events:none;z-index:10;display:none">
  <span id="hudCoins" style="position:absolute;top:10px;left:10px;color:#ffd700;font:bold 15px Arial">\uD83C\uDFB50</span>
  <span id="hudScore" style="position:absolute;top:6px;right:10px;color:#fff;font:bold 28px Arial">0</span>
  <span id="hudHeart" style="position:absolute;top:30px;left:10px;font:15px Arial"></span>
</div>

<!-- â”€â”€ Game canvas (hidden until game starts) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<canvas id="gameCanvas" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) translateZ(0)"></canvas>

<script type="module">
// â”€â”€ Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, collection, doc,
         getDoc, setDoc, getDocs,
         query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey:            "AIzaSyCv02h10zIVw8DhrBhryiDnFIa_peZklKQ",
  authDomain:        "flappy-bobby.firebaseapp.com",
  projectId:         "flappy-bobby",
  storageBucket:     "flappy-bobby.firebasestorage.app",
  messagingSenderId: "79131027037",
  appId:             "1:79131027037:web:2224f6d16ef4f7e6a88fb4"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// â”€â”€ Leaderboard cache canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const lbCacheCanvas = document.createElement('canvas');
const lbCtx = lbCacheCanvas.getContext('2d');
let lbCacheReady = false;

// â”€â”€ Character definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CHARACTERS = {
  bobby:    { name:'Bobby',     img:'bobby.png',    price:0,   col:'soundcloud.png',
              bonuses:[],                         desc:'brak bonusÃ³w' },
  bialek:   { name:'Bialek',    img:'bialek.png',   price:30,  col:'nina.png',
              bonuses:['gap+20'],                 desc:'+szerszy przelot' },
  deadman:  { name:'Deadman',   img:'deadman.png',  price:60,  col:'grammy.png',
              bonuses:['speed-10'],               desc:'rury âˆ’10%' },
  krystian: { name:'Krystian',  img:'krystian.png', price:100, col:'diormind.png',
              bonuses:['double'],                 desc:'Ã—2 punkty' },
  johnny:   { name:'Johnny',    img:'johnny.png',   price:150, col:'joint.png',
              bonuses:['gap+20','speed-10'],      desc:'+przelot, rury âˆ’10%' },
  kolin:    { name:'Kolin',     img:'kolin.png',    price:200, col:'strzykawka.png',
              bonuses:['extralife'],              desc:'+1 Å¼ycie' },
  kutasa:   { name:'Kutasa',    img:'kutasa.png',   price:250, col:'dziecko.png',
              bonuses:['speed-15','double'],      desc:'rury âˆ’15%, Ã—2 pkt' },
  reczu:    { name:'Reczu',     img:'reczu.png',    price:300, col:'kutas.png',
              bonuses:['gap+30','extralife'],     desc:'+przelot 30px, +1 Å¼ycie' },
  szpachl:  { name:'Szpachl',   img:'szpachl.png',  price:400, col:'scat.png',
              bonuses:['speed-20','gap+30','double'], desc:'rury âˆ’20%, +przelot 30px, Ã—2 pkt' },
  tom:      { name:'Tom',       img:'tom.png',      price:500, col:'wozek.png',
              bonuses:['extralife','double','speed-20'], desc:'+Å¼ycie, Ã—2 pkt, rury âˆ’20%' },
  majka:    { name:'Majka ğŸ‘‘',  img:'majka.png',    price:666, col:'onlyfans.png',
              bonuses:['gap+60','speed-40','double','extralife'],
              desc:'WSZYSTKO: âˆ’40% rury, +60px, Ã—2, +Å¼ycie', special:true },
};
const CHAR_KEYS = Object.keys(CHARACTERS);

// â”€â”€ Firestore helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPlayerData(nick) {
  try {
    const snap = await getDoc(doc(db, 'leaderboard', nick));
    if (snap.exists()) {
      const d = snap.data();
      // Normalize unlockedSkins â€” Firestore moÅ¼e zwrÃ³ciÄ‡ array, string-JSON lub undefined
      let skins = d.unlockedSkins;
      if (!Array.isArray(skins)) {
        if (typeof skins === 'string') {
          try { skins = JSON.parse(skins); } catch { skins = ['bobby']; }
          if (!Array.isArray(skins)) skins = ['bobby'];
        } else {
          skins = ['bobby'];
        }
      }
      return { coins: d.coins ?? 0, unlockedSkins: skins, activeSkin: d.activeSkin ?? 'bobby' };
    }
  } catch(e) { console.warn('loadPlayerData:', e); }
  return { coins: 0, unlockedSkins: ['bobby'], activeSkin: 'bobby' };
}

async function saveProgress() {
  try {
    await setDoc(doc(db, 'leaderboard', playerNick),
      { coins: playerCoins, unlockedSkins, activeSkin }, { merge: true });
  } catch(e) { console.warn('saveProgress:', e); }
}

async function saveScoreAndProgress(roundScore) {
  try {
    const ref  = doc(db, 'leaderboard', playerNick);
    const snap = await getDoc(ref);
    const best = snap.exists() ? Math.max(roundScore, snap.data().score ?? 0) : roundScore;
    await setDoc(ref, {
      nick: playerNick, score: best, date: new Date(),
      coins: playerCoins, unlockedSkins, activeSkin
    }, { merge: true });
  } catch(e) { console.warn('saveScoreAndProgress:', e); }
}

async function getTopScores() {
  try {
    const snap = await getDocs(
      query(collection(db, 'leaderboard'), orderBy('score','desc'), limit(10))
    );
    return snap.docs.map(d => d.data());
  } catch(e) { console.warn('getTopScores:', e); return []; }
}

// â”€â”€ Canvas & DPR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas = document.getElementById('gameCanvas');
const ctx    = canvas.getContext('2d');
const GW = 400, GH = 600;
const isMobile = window.innerWidth < 600;
const dpr = Math.min(window.devicePixelRatio || 1, isMobile ? 1.5 : 2);
canvas.width  = Math.round(GW * dpr);
canvas.height = Math.round(GH * dpr);
canvas.style.imageRendering = 'auto';
ctx.scale(dpr, dpr);

let canvasRect = { left: 0, top: 0, width: GW, height: GH };
const _touchPos = { x: 0, y: 0 };

function resize() {
  const s = Math.min(window.innerWidth / GW, window.innerHeight / GH);
  canvas.style.width  = (GW * s) + 'px';
  canvas.style.height = (GH * s) + 'px';
  setTimeout(() => { canvasRect = canvas.getBoundingClientRect(); }, 0);
}
window.addEventListener('resize', resize);

// â”€â”€ Base constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GRAVITY = 0.45, JUMP_FORCE = -9.5, PIPE_SPEED = 2.55;
const PIPE_GAP = 175, PIPE_WIDTH = 72, PIPE_INTERVAL = 1750;
const BIRD_SIZE = 60, COL_W = 70;

// â”€â”€ Pre-rendered background (stars) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STARS = Array.from({ length: 25 }, () => ({
  x: Math.random() * GW, y: Math.random() * GH * 0.75,
  r: Math.random() < 0.3 ? 1.5 : 1
}));
const bgCacheCanvas = document.createElement('canvas');
const bgCtx = bgCacheCanvas.getContext('2d');
function renderBackgroundToCache() {
  bgCacheCanvas.width = GW; bgCacheCanvas.height = GH;
  bgCtx.fillStyle = '#0f1432';
  bgCtx.fillRect(0, 0, GW, GH);
  bgCtx.fillStyle = '#b4c8ff';
  for (const s of STARS) { bgCtx.beginPath(); bgCtx.arc(s.x, s.y, s.r, 0, Math.PI*2); bgCtx.fill(); }
}
renderBackgroundToCache();

// â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Background music â€” HTMLAudioElement (streaming)
const bgMusic = new Audio('assets/sounds/music.mp3');
bgMusic.loop = true; bgMusic.volume = 0.3;
function startMusic() { bgMusic.currentTime = 0; bgMusic.play().catch(e => console.warn('music blocked:', e)); }
function stopMusic()  { bgMusic.pause(); }

// Sound effects â€” Web Audio API (low-latency, no pool needed)
const _AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new _AudioContext();
const audioBuffers = {};

async function loadAudioBuffer(key, url) {
  try {
    const res = await fetch(url);
    const arr = await res.arrayBuffer();
    audioBuffers[key] = await audioCtx.decodeAudioData(arr);
  } catch(e) { console.warn('Audio load error:', key, e); }
}

function playSound(key, vol = 1.0) {
  if (!audioBuffers[key]) return;
  const src = audioCtx.createBufferSource();
  src.buffer = audioBuffers[key];
  const gain = audioCtx.createGain();
  gain.gain.value = vol;
  src.connect(gain);
  gain.connect(audioCtx.destination);
  src.start(0);
}

const playKaching  = () => playSound('kaching',  0.5);
const playMumia    = () => playSound('mumia',    1.0);
const playDzwiek7  = () => playSound('dzwiek7',  1.0);
const playKrystian = () => playSound('krystian', 1.0);

loadAudioBuffer('kaching',  'assets/sounds/kaching.wav');
loadAudioBuffer('mumia',    'assets/sounds/mumia.mp3');
loadAudioBuffer('dzwiek7',  'assets/sounds/7.mp3');
loadAudioBuffer('krystian', 'assets/sounds/krystian.mp3');

function playSpecialSound(sc) {
  if (sc <= 0) return;
  if      (sc % 100 === 0) playKrystian();
  else if (sc % 10  === 0) playMumia();
  else if (sc % 10  === 7) playDzwiek7();
}

// â”€â”€ Image helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadImage(src) {
  return new Promise(resolve => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload  = () => resolve(img);
    img.onerror = () => { console.warn('Failed to load image:', src); resolve(null); };
    img.src = src;
  });
}
// Per-skin caches
const spriteCache     = {}; // key â†’ Image
const collectCache    = {}; // key â†’ { img, h }

async function ensureSprite(key) {
  if (spriteCache[key] !== undefined) return;
  spriteCache[key] = await loadImage(`assets/characters/${CHARACTERS[key].img}`);
}
async function ensureCollectible(key) {
  if (collectCache[key] !== undefined) return;
  const img = await loadImage(`assets/collectibles/${CHARACTERS[key].col}`);
  if (img) {
    const h = Math.max(1, Math.round(img.naturalHeight * COL_W / img.naturalWidth));
    collectCache[key] = { img, h };
  } else {
    collectCache[key] = null;
  }
}

// Active skin assets (set in applyActiveSkin)
let playerImg       = null;
let collectImg      = null;
let collectH        = COL_W;

async function applyActiveSkin(key) {
  await ensureSprite(key);
  await ensureCollectible(key);
  playerImg   = spriteCache[key] || null;
  const c = collectCache[key];
  collectImg  = c ? c.img : null;
  collectH    = c ? c.h   : COL_W;
}

// â”€â”€ Player state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let playerNick    = '';
let playerCoins   = 0;
let unlockedSkins = ['bobby'];
let activeSkin    = 'bobby';

// â”€â”€ Session params (computed from active skin) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let S_GAP = PIPE_GAP, S_SPEED = PIPE_SPEED, S_DOUBLE = false, S_EXTRA = false;
let S_INTERVAL = PIPE_INTERVAL;

function computeSessionParams() {
  const b = CHARACTERS[activeSkin].bonuses;
  S_GAP  = PIPE_GAP + (b.includes('gap+60')?60 : b.includes('gap+30')?30 : b.includes('gap+20')?20 : 0);
  S_SPEED = PIPE_SPEED * (b.includes('speed-40')?.60 : b.includes('speed-20')?.80
                        : b.includes('speed-15')?.85 : b.includes('speed-10')?.90 : 1);
  S_DOUBLE = b.includes('double');
  S_EXTRA  = b.includes('extralife');
  S_INTERVAL = PIPE_INTERVAL * (PIPE_SPEED / S_SPEED);
}

// â”€â”€ Extra life â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let extraLifeAvail = false;
let flashUntil     = 0;

// â”€â”€ Screen management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nickScreen  = document.getElementById('nickScreen');
const lobbyScreen = document.getElementById('lobbyScreen');
const shopScreen  = document.getElementById('shopScreen');

let isGameCanvasVisible = false;

function hideAll() {
  nickScreen.style.display = lobbyScreen.style.display =
  shopScreen.style.display = canvas.style.display =
  hudEl.style.display = 'none';
  isGameCanvasVisible = false;
}
function showLobby() {
  hideAll();
  lobbyScreen.style.display = 'flex';
  updateLobbyUI();
}
function showShop() {
  hideAll();
  shopScreen.style.display = 'flex';
  renderShop();
}
function showGame() {
  hideAll();
  canvas.style.display = hudEl.style.display = 'block';
  isGameCanvasVisible = true;
  resize();
  startGameLoop();
}

// â”€â”€ Nick screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nickInput   = document.getElementById('nickInput');
const nickConfirm = document.getElementById('nickConfirm');
let nickDone = false;

async function onNickConfirm() {
  if (nickDone) return;
  const val = nickInput.value.trim();
  if (!val) { nickInput.classList.add('error'); return; }
  nickInput.classList.remove('error');
  nickDone = true;

  playerNick = val.slice(0, 16);
  const data = await loadPlayerData(playerNick);
  playerCoins   = data.coins;
  unlockedSkins = data.unlockedSkins;
  if (!unlockedSkins.includes('bobby')) unlockedSkins.push('bobby');
  activeSkin    = unlockedSkins.includes(data.activeSkin) ? data.activeSkin : 'bobby';

  await applyActiveSkin(activeSkin);
  showLobby();
}

nickConfirm.addEventListener('click',    onNickConfirm);
nickConfirm.addEventListener('touchend', e => { e.preventDefault(); onNickConfirm(); });
nickInput.addEventListener('keydown', e => { if (e.key === 'Enter') onNickConfirm(); e.stopPropagation(); });
nickInput.focus();

// â”€â”€ Lobby UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateLobbyUI() {
  document.getElementById('lobbyNick').textContent        = playerNick;
  document.getElementById('lobbyCoins').textContent       = '\uD83C\uDFB5 ' + playerCoins + ' coin\xF3w';
  document.getElementById('charPreviewName').textContent  = CHARACTERS[activeSkin].name;
  document.getElementById('charPreviewBonus').textContent = CHARACTERS[activeSkin].desc;
  document.getElementById('charPreviewImg').src           = `assets/characters/${CHARACTERS[activeSkin].img}`;
  renderCharPicker();
}

function renderCharPicker() {
  const bar = document.getElementById('charPicker');
  if (!bar) return;
  bar.innerHTML = '';
  CHAR_KEYS.forEach(key => {
    const ch     = CHARACTERS[key];
    const owned  = unlockedSkins.includes(key);
    const active = activeSkin === key;

    const wrap = document.createElement('div');
    wrap.style.cssText =
      `flex-shrink:0;position:relative;border-radius:8px;
       border:2px solid ${active ? '#ffd700' : 'transparent'};
       opacity:${owned ? 1 : 0.4};
       cursor:${owned ? 'pointer' : 'default'};
       touch-action:manipulation;`;

    const img = document.createElement('img');
    img.src = `assets/characters/${ch.img}`;
    img.alt = ch.name;
    img.title = ch.name;
    img.style.cssText = 'width:50px;height:50px;object-fit:cover;border-radius:6px;display:block;background:#0f1432';

    wrap.appendChild(img);

    if (!owned) {
      const lock = document.createElement('div');
      lock.style.cssText =
        'position:absolute;inset:0;display:flex;align-items:center;' +
        'justify-content:center;font-size:16px;pointer-events:none;border-radius:6px;' +
        'background:rgba(0,0,0,.35)';
      lock.textContent = '\uD83D\uDD12';
      wrap.appendChild(lock);
    }

    if (owned) {
      let pGuard = false;
      async function pickChar(e) {
        if (e) e.preventDefault();
        if (pGuard || activeSkin === key) return;
        pGuard = true;
        activeSkin = key;
        await applyActiveSkin(key);
        await saveProgress();
        updateLobbyUI();
      }
      wrap.addEventListener('click',    pickChar);
      wrap.addEventListener('touchend', pickChar);
    }

    bar.appendChild(wrap);
  });
}

let lobbyPlayGuard = false;
async function onLobbyPlay() {
  if (lobbyPlayGuard) return;
  lobbyPlayGuard = true;
  computeSessionParams();
  await applyActiveSkin(activeSkin);
  initNewSession();
  showGame();
}

const lobbyPlay = document.getElementById('lobbyPlay');
const lobbyShop = document.getElementById('lobbyShop');
lobbyPlay.addEventListener('click',    onLobbyPlay);
lobbyPlay.addEventListener('touchend', e => { e.preventDefault(); onLobbyPlay(); });
lobbyShop.addEventListener('click',    () => showShop());
lobbyShop.addEventListener('touchend', e => { e.preventDefault(); showShop(); });

// â”€â”€ Shop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onShopBack() {
  if (shopFromWaiting) {
    shopFromWaiting = false;
    computeSessionParams(); initNewSession();
    hideAll();
    canvas.style.display = hudEl.style.display = 'block';
    isGameCanvasVisible = true;
    resize();
  } else { showLobby(); }
}
document.getElementById('shopBack').addEventListener('click',    () => onShopBack());
document.getElementById('shopBack').addEventListener('touchend', e => { e.preventDefault(); onShopBack(); });

function renderShop() {
  document.getElementById('shopCoins').textContent = 'ğŸµ ' + playerCoins;
  const grid = document.getElementById('shopGrid');
  if (!grid) { console.error('[Shop] shopGrid element not found!'); return; }
  grid.innerHTML = '';

  CHAR_KEYS.forEach(key => {
    const ch       = CHARACTERS[key];
    const owned    = unlockedSkins.includes(key);
    const isActive = activeSkin === key;
    const canBuy   = !owned && playerCoins >= ch.price;
    const card = document.createElement('div');
    card.className = 'char-card' + (isActive ? ' active-card' : '') + (ch.special ? ' majka-card' : '');

    const img = document.createElement('img');
    img.src = `assets/characters/${ch.img}`;
    img.alt = ch.name;
    img.onerror = () => { img.style.opacity = '.3'; };

    const name = document.createElement('div');
    name.className = 'cc-name'; name.textContent = ch.name;

    const bonuses = document.createElement('div');
    bonuses.className = 'cc-bonuses'; bonuses.textContent = ch.desc;

    const btn = document.createElement('button');
    btn.className = 'cc-btn ' + (isActive ? 'active' : owned ? 'select' : canBuy ? 'buy' : 'locked');
    btn.textContent = isActive ? 'âœ“ AKTYWNA'
                    : owned    ? 'WYBIERZ'
                    : canBuy   ? `KUP \uD83C\uDFB5${ch.price}`
                    :            `\uD83D\uDD12 ${ch.price}\uD83C\uDFB5`;
    if (isActive || (!owned && !canBuy)) btn.disabled = true;

    let guard = false;
    async function doAction(e) {
      if (e) e.preventDefault();
      if (guard) return;
      guard = true;
      if (owned) {
        activeSkin = key;
        await applyActiveSkin(key);
        await saveProgress();
        renderShop();
        updateLobbyUI();
      } else {
        if (playerCoins < ch.price) { console.warn('[Shop] not enough coins'); guard = false; return; }
        playerCoins   -= ch.price;
        unlockedSkins.push(key);
        activeSkin     = key;
        await applyActiveSkin(key);
        await saveProgress();
        renderShop();
        updateLobbyUI();
      }
    }
    btn.addEventListener('click',    doAction);
    btn.addEventListener('touchend', doAction);

    card.append(img, name, bonuses, btn);
    grid.appendChild(card);
  });
}

// â”€â”€ Game state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state  = 'waiting';
let score  = 0;
const MAX_PIPES = 6;
const pipePool = Array.from({ length: MAX_PIPES }, () => ({
  active: false, x: 0, topH: 0, botY: 0, passed: false, collected: false
}));
function spawnPipe() {
  const p = pipePool.find(pipe => !pipe.active);
  if (!p) return;
  const gc = GH/4 + Math.random() * (GH/2);
  p.active = true; p.x = GW;
  p.topH = gc - S_GAP/2; p.botY = gc + S_GAP/2;
  p.passed = false; p.collected = false;
}
let pipeTimer  = 0;
let gameOverAt = 0;
let leaderboard = [], leaderboardLoading = false;

// DOM HUD elements
const hudEl      = document.getElementById('hud');
const hudCoinsEl = document.getElementById('hudCoins');
const hudScoreEl = document.getElementById('hudScore');
const hudHeartEl = document.getElementById('hudHeart');
let _hud_coins = -1, _hud_score = -1, _hud_extra = null;

function updateHUD() {
  if (_hud_coins !== playerCoins) {
    _hud_coins = playerCoins;
    hudCoinsEl.textContent = '\uD83C\uDFB5' + playerCoins;
  }
  if (_hud_score !== score) {
    _hud_score = score;
    hudScoreEl.textContent = score;
  }
  const heartState = S_EXTRA ? (extraLifeAvail ? '\u2665' : '\u2661') : '';
  if (_hud_extra !== heartState) {
    _hud_extra = heartState;
    hudHeartEl.textContent = heartState;
    hudHeartEl.style.color = (S_EXTRA && extraLifeAvail) ? '#dc3232' : '#444';
  }
}

const bird = {
  x: 80, y: GH / 2, vy: 0,
  _r: { x: 0, y: 0, w: BIRD_SIZE - 16, h: BIRD_SIZE - 16 },
  jump()     { this.vy = JUMP_FORCE; },
  update(dt) { const f = dt/16.667; this.vy += GRAVITY*f; this.y += this.vy*f; },
  rect()     { this._r.x = this.x + 8; this._r.y = this.y + 8; return this._r; }
};

// Reusable scratch rects â€” no per-frame allocation
const _cr = { x:0, y:0, w:COL_W,      h:0 };
const _pr = { x:0, y:0, w:PIPE_WIDTH, h:0 };

function initNewSession() {
  bird.x = 80; bird.y = GH/2; bird.vy = 0;
  for (let i = 0; i < MAX_PIPES; i++) pipePool[i].active = false;
  pipeTimer = 0; score = 0;
  leaderboard = []; leaderboardLoading = false; lbCacheReady = false;
  extraLifeAvail = S_EXTRA; flashUntil = 0;
  _hud_coins = -1; _hud_score = -1; _hud_extra = null;
  state = 'waiting';
  stopMusic();
}
function resetGame() {   // within-session reset (after regular game over)
  bird.x = 80; bird.y = GH/2; bird.vy = 0;
  for (let i = 0; i < MAX_PIPES; i++) pipePool[i].active = false;
  pipeTimer = 0; score = 0;
  leaderboard = []; leaderboardLoading = false;
  extraLifeAvail = S_EXTRA; flashUntil = 0;
  stopMusic(); state = 'waiting';
}
function startGame() {
  state = 'playing';
  bird.jump();
  startMusic();
}
async function die() {
  // Extra life shield
  if (extraLifeAvail) {
    extraLifeAvail = false;
    flashUntil = performance.now() + 1200;
    return;
  }
  stopMusic();
  gameOverAt = performance.now();
  state = 'gameover';                      // zwykÅ‚a Å›mierÄ‡ â†’ game over (auto-reset 3s)
  leaderboardLoading = true;
  leaderboard = [];
  await saveScoreAndProgress(score);
  leaderboard = await getTopScores();
  leaderboardLoading = false;
  lbCacheCanvas.width = GW; lbCacheCanvas.height = 300;
  lbCtx.clearRect(0, 0, GW, 300);
  if (!leaderboard.length) {
    lbCtx.font = '13px Arial'; lbCtx.fillStyle = '#888'; lbCtx.textAlign = 'center';
    lbCtx.fillText('Brak wynikÃ³w', GW/2, 22);
  } else {
    leaderboard.forEach((e, i) => {
      const ry = 20 + i * 22;
      const color = e.nick === playerNick ? '#ffd700' : (i < 3 ? '#fff' : '#909090');
      lbCtx.font = '13px Arial'; lbCtx.fillStyle = color;
      lbCtx.textAlign = 'left';  lbCtx.fillText(`${i+1}. ${e.nick}`, 22, ry);
      lbCtx.textAlign = 'right'; lbCtx.fillText(String(e.score), GW-22, ry);
    });
  }
  lbCacheReady = true;
}

function overlaps(a, b) {
  return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
}

// â”€â”€ Update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function update(dt) {
  if (state === 'gameover') {
    if ((performance.now() - gameOverAt) / 1000 >= 3) resetGame();
    return;
  }
  if (state !== 'playing') return;

  bird.update(dt);

  pipeTimer += dt;
  if (pipeTimer >= S_INTERVAL) { spawnPipe(); pipeTimer = 0; }

  const f = dt / 16.667;
  const br = bird.rect();
  for (let i = 0; i < MAX_PIPES; i++) {
    const p = pipePool[i];
    if (!p.active) continue;
    p.x -= S_SPEED * f;
    if (!p.passed && p.x + PIPE_WIDTH < bird.x) p.passed = true;
    if (p.x + PIPE_WIDTH <= 0) { p.active = false; continue; }
    if (!p.collected) {
      _cr.x = p.x + PIPE_WIDTH/2 - COL_W/2;
      _cr.y = (p.topH + p.botY)/2 - collectH/2;
      _cr.h = collectH;
      if (overlaps(br, _cr)) {
        p.collected = true;
        const pts = S_DOUBLE ? 2 : 1;
        score += pts; playerCoins += pts;
        playKaching(); playSpecialSound(score);
      }
    }
    _pr.x = p.x; _pr.y = 0; _pr.h = p.topH;
    if (overlaps(br, _pr)) { die(); return; }
    _pr.y = p.botY; _pr.h = GH - p.botY;
    if (overlaps(br, _pr)) { die(); return; }
  }
  if (bird.y > GH || bird.y < -BIRD_SIZE) { die(); return; }
}

// â”€â”€ Draw helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function txt(str, x, y, font, color, align = 'center') {
  ctx.font = font; ctx.fillStyle = color; ctx.textAlign = align;
  ctx.fillText(str, x, y);
}
function overlay(a) { ctx.fillStyle = `rgba(0,0,0,${a})`; ctx.fillRect(0, 0, GW, GH); }

function drawBirdAt(x, y, angle) {
  ctx.save();
  ctx.translate(x + BIRD_SIZE/2, y + BIRD_SIZE/2);
  ctx.rotate(angle * Math.PI / 180);
  if (playerImg)
    ctx.drawImage(playerImg, -BIRD_SIZE/2, -BIRD_SIZE/2, BIRD_SIZE, BIRD_SIZE);
  else {
    ctx.fillStyle = '#ffd700';
    ctx.beginPath(); ctx.arc(0, 0, BIRD_SIZE/2-4, 0, Math.PI*2); ctx.fill();
  }
  // Red flash on extra-life use
  const now = performance.now();
  if (now < flashUntil && Math.floor(now/100) % 2 === 0) {
    ctx.globalAlpha = 0.55;
    ctx.fillStyle = '#ff2222';
    ctx.beginPath(); ctx.arc(0, 0, BIRD_SIZE/2, 0, Math.PI*2); ctx.fill();
    ctx.globalAlpha = 1;
  }
  ctx.restore();
}

function drawLeaderboard(y0) {
  txt('\uD83C\uDFC6 TOP 10', GW/2, y0, 'bold 15px Arial', '#ffd700');
  if (leaderboardLoading) { txt('Åadowanie...', GW/2, y0+22, '13px Arial', '#888'); return; }
  if (lbCacheReady) ctx.drawImage(lbCacheCanvas, 0, y0);
}

// â”€â”€ Screens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Shop button rect on waiting screen (right-bottom)
const SHOP_BTN = { x: GW - 120, y: GH - 80, w: 110, h: 64 };

function drawWaiting() {
  txt('Bobby Bird', GW/2, GH/4+10, 'bold 52px Arial', '#ffd700');
  const hy = GH/2 - BIRD_SIZE/2 + Math.sin(performance.now()/333)*12;
  drawBirdAt(GW/2 - BIRD_SIZE/2, hy, 0);
  if (Math.floor(performance.now()/600) % 2 === 0)
    txt('Tap lub SPACJA aby zaczÄ…Ä‡', GW/2, GH*2/3+10, 'bold 20px Arial', '#fff');

  // Shop button
  const b = SHOP_BTN;
  ctx.fillStyle = '#1a6aff';
  ctx.beginPath();
  ctx.roundRect(b.x, b.y, b.w, b.h, 12);
  ctx.fill();
  txt('\uD83D\uDED2 SKLEP', b.x + b.w/2, b.y + b.h/2 + 7, 'bold 18px Arial', '#fff');
}
function drawGameOver() {
  overlay(0.62);
  txt('GAME OVER', GW/2, 72, 'bold 44px Arial', '#dc3232');
  txt('Score: '+score, GW/2, 108, 'bold 26px Arial', '#ffd700');
  ctx.strokeStyle='#444'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(20,122); ctx.lineTo(GW-20,122); ctx.stroke();
  drawLeaderboard(138);
  ctx.beginPath(); ctx.moveTo(20,380); ctx.lineTo(GW-20,380); ctx.stroke();
  const rem = Math.max(0, 3-(performance.now()-gameOverAt)/1000).toFixed(1);
  txt('Restart za '+rem+'s  â€¢  Tap aby teraz', GW/2, 402, '15px Arial', '#888');
}
// â”€â”€ Main draw â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function draw() {
  if (state === 'waiting') {
    ctx.globalAlpha = 0.65;
    ctx.drawImage(bgCacheCanvas, 0, 0);
    ctx.globalAlpha = 1.0;
  } else {
    ctx.drawImage(bgCacheCanvas, 0, 0);
  }

  // Pass 1: pipe bodies
  ctx.fillStyle = '#22b422';
  for (let i = 0; i < MAX_PIPES; i++) {
    const p = pipePool[i];
    if (!p.active) continue;
    if (p.topH > 0) ctx.fillRect(p.x, 0, PIPE_WIDTH, p.topH);
    if (p.botY < GH) ctx.fillRect(p.x, p.botY, PIPE_WIDTH, GH - p.botY);
  }
  // Pass 2: pipe caps
  ctx.fillStyle = '#127812';
  const _cap = 28, _bw = PIPE_WIDTH + 20;
  for (let i = 0; i < MAX_PIPES; i++) {
    const p = pipePool[i];
    if (!p.active) continue;
    const bx = p.x - 10;
    if (p.topH > 0) ctx.fillRect(bx, p.topH - _cap, _bw, _cap);
    if (p.botY < GH) ctx.fillRect(bx, p.botY, _bw, _cap);
  }
  // Pass 3: collectibles
  if (collectImg) {
    for (let i = 0; i < MAX_PIPES; i++) {
      const p = pipePool[i];
      if (p.active && !p.collected)
        ctx.drawImage(collectImg, p.x+PIPE_WIDTH/2-COL_W/2, (p.topH+p.botY)/2-collectH/2, COL_W, collectH);
    }
  }
  if (state !== 'waiting')
    drawBirdAt(bird.x, bird.y, Math.max(-35, Math.min(50, -bird.vy*3)));

  updateHUD();

  if      (state === 'waiting')  drawWaiting();
  else if (state === 'gameover') drawGameOver();
}

// â”€â”€ Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function canvasXY(e) {
  const cx = (e.clientX ?? e.touches?.[0]?.clientX ?? 0) - canvasRect.left;
  const cy = (e.clientY ?? e.touches?.[0]?.clientY ?? 0) - canvasRect.top;
  _touchPos.x = cx / canvasRect.width * GW;
  _touchPos.y = cy / canvasRect.height * GH;
  return _touchPos;
}
function hitShopBtn(px, py) {
  const b = SHOP_BTN;
  return px >= b.x && px <= b.x+b.w && py >= b.y && py <= b.y+b.h;
}

function onAction(px, py) {
  if (state === 'waiting' && px !== undefined && hitShopBtn(px, py)) {
    showShopFromWaiting(); return;
  }
  if (state === 'waiting')  { startGame(); return; }
  if (state === 'playing')  { bird.jump(); return; }
  if (state === 'gameover') { resetGame(); return; }
}

// Shop from waiting screen â€” show shop, return to waiting on back
let shopFromWaiting = false;
function showShopFromWaiting() {
  shopFromWaiting = true;
  showShop();
}
document.addEventListener('keydown', e => { if (e.code === 'Space') { e.preventDefault(); onAction(); } });
canvas.addEventListener('mousedown',  e => { e.preventDefault(); const p = canvasXY(e); onAction(p.x, p.y); });
canvas.addEventListener('touchstart', e => { e.preventDefault(); const p = canvasXY(e); onAction(p.x, p.y); }, { passive: false });

// â”€â”€ Game loop (starts once, runs forever) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastTime = performance.now(), loopRunning = false;
let accumulator = 0;
const TIME_STEP = 16.667;

function loop(now) {
  if (!loopRunning) return;
  requestAnimationFrame(loop);
  let dt = now - lastTime; lastTime = now;
  if (dt > 100) dt = 100;
  if (isGameCanvasVisible) {
    accumulator += dt;
    while (accumulator >= TIME_STEP) { update(TIME_STEP); accumulator -= TIME_STEP; }
    if (state === 'playing' || state === 'waiting' || state === 'gameover') draw();
  }
}
function startGameLoop() {
  if (loopRunning) return;
  loopRunning = true;
  lastTime = performance.now();
  accumulator = 0;
  requestAnimationFrame(loop);
}

// â”€â”€ Visibility change â€” reset accumulator after tab switch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('visibilitychange', () => { lastTime = performance.now(); accumulator = 0; });

// â”€â”€ Audio prewarm â€” unlock AudioContext on first user gesture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let audioUnlocked = false;
function unlockAudioOnFirstTouch() {
  if (audioUnlocked) return;
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const silence = new Audio();
  silence.src = 'data:audio/mp3;base64,//OExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq';
  silence.play().catch(() => {});
  audioUnlocked = true;
}
document.addEventListener('touchstart', unlockAudioOnFirstTouch, { once: true });
document.addEventListener('mousedown',  unlockAudioOnFirstTouch, { once: true });
</script>
</body>
</html>
