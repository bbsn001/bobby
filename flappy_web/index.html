<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Bobby Bird</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0a0a2e" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Bobby Bird" />
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%; height: 100%;
      background: #0a0a2e;
      font-family: Arial, sans-serif;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    canvas {
      display: block; touch-action: none; user-select: none;
      will-change: transform; transform: translateZ(0);
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }

    /* â”€â”€ Shared screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .screen {
      position: fixed; inset: 0;
      background: #0a0a2e;
      display: flex; flex-direction: column; align-items: center;
      overflow-y: auto; -webkit-overflow-scrolling: touch;
      z-index: 100;
    }
    .screen-inner {
      width: 100%; max-width: 500px;
      padding: 32px 20px;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100%;
      justify-content: center;
    }
    .screen-title  { color: #ffd700; font-size: 2.2em; font-weight: bold; margin-bottom: 6px; text-align: center; }
    .screen-sub    { color: #aaa; font-size: .88rem; margin-bottom: 24px; text-align: center; }

    /* â”€â”€ Inputs / Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .big-input {
      width: 80%; max-width: 280px; height: 58px;
      font-size: 16px; padding: 0 16px; text-align: center;
      border: 2px solid #ffd700; border-radius: 10px;
      background: #0f1432; color: #fff; outline: none;
      margin-bottom: 14px;
    }
    .big-input.error { border-color: #dc3232; }
    .btn {
      display: flex; align-items: center; justify-content: center;
      width: 80%; max-width: 280px; height: 56px;
      font-size: 1.1rem; font-weight: bold;
      border: none; border-radius: 10px; cursor: pointer;
      touch-action: manipulation; margin-bottom: 10px;
      transition: filter .12s;
    }
    .btn:active { filter: brightness(.82); }
    .btn-yellow { background: #ffd700; color: #0f1432; }
    .btn-blue   { background: #1a6aff; color: #fff; }
    .btn-dark   { background: #1e1e4a; color: #aaa; border: 1px solid #333; }
    .btn-sm     { height: 40px; font-size: .88rem; width: auto; padding: 0 18px; margin-bottom: 0; }

    /* â”€â”€ Coins badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .coins { color: #ffd700; font-size: 1.05rem; margin-bottom: 16px; }

    /* â”€â”€ Character preview (lobby) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .char-preview {
      display: flex; align-items: center; gap: 12px;
      background: #131340; border: 1px solid #2a2a6a;
      border-radius: 12px; padding: 10px 14px;
      margin-bottom: 20px; width: 80%; max-width: 280px;
    }
    .char-preview img { width: 48px; height: 48px; object-fit: cover; border-radius: 8px; background: #0f1432; }
    .cp-name  { color: #fff; font-weight: bold; font-size: .9rem; }
    .cp-bonus { color: #8be; font-size: .72rem; margin-top: 2px; }

    /* â”€â”€ Shop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .shop-header {
      display: flex; justify-content: space-between; align-items: center;
      width: 100%; margin-bottom: 18px;
    }
    .shop-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px; width: 100%;
    }
    @media (min-width: 460px) { .shop-grid { grid-template-columns: repeat(3, 1fr); } }

    .char-card {
      background: #131340; border: 2px solid #2a2a6a;
      border-radius: 12px; padding: 10px 8px 10px;
      display: flex; flex-direction: column; align-items: center; gap: 5px;
      position: relative;
    }
    .char-card.active-card { border-color: #22b422; }
    .char-card.majka-card  { border-color: #ffd700; box-shadow: 0 0 14px #ffd70055; }
    .char-card img {
      width: 68px; height: 68px; object-fit: cover;
      border-radius: 8px; background: #0f1432;
    }
    .cc-name    { color: #fff; font-weight: bold; font-size: .85rem; text-align: center; }
    .cc-bonuses { color: #8be; font-size: .62rem; text-align: center; line-height: 1.35; min-height: 26px; }
    .cc-btn {
      width: 100%; height: 34px;
      font-size: .78rem; font-weight: bold;
      border: none; border-radius: 7px; cursor: pointer;
      touch-action: manipulation; margin-top: 2px;
    }
    .cc-btn.active  { background: #22b422; color: #fff; }
    .cc-btn.select  { background: #1a6aff; color: #fff; }
    .cc-btn.buy     { background: #ffd700; color: #0f1432; }
    .cc-btn.locked  { background: #1e1e4a; color: #444; cursor: default; }

    /* â”€â”€ Char picker (lobby) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #charPicker { scrollbar-width: none; }
    #charPicker::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>

<!-- â”€â”€ Nick screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="nickScreen" class="screen">
  <div class="screen-inner">
    <div class="screen-title">ğŸ¦ Bobby Bird</div>
    <div class="screen-sub">Zaloguj siÄ™ lub stwÃ³rz konto (z PINem)</div>

    <input id="nickInput" class="big-input" type="text" maxlength="16"
      placeholder="TwÃ³j nick"
      autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />

    <input id="pinInput" class="big-input" type="password" maxlength="4"
      inputmode="numeric" placeholder="PIN (4 cyfry)"
      autocomplete="off" style="margin-bottom:8px" />

    <div id="loginError" style="color:#dc3232; font-size:14px; font-weight:bold; margin-bottom:12px; display:none;">
      BÅ‚Ä™dny PIN!
    </div>

    <button id="nickConfirm" class="btn btn-yellow">DALEJ â†’</button>
  </div>
</div>

<!-- â”€â”€ Lobby screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="lobbyScreen" class="screen" style="display:none">
  <div class="screen-inner">
    <div class="screen-title" style="font-size:1.55em;margin-bottom:2px">Bobby Bird</div>
    <div id="lobbyNick" style="color:#aaa;font-size:.85rem;margin-bottom:10px"></div>
    <div id="lobbyCoins" class="coins">ğŸµ 0 coinÃ³w</div>

    <div id="charPreview" class="char-preview">
      <img id="charPreviewImg" src="" alt="" />
      <div>
        <div id="charPreviewName" class="cp-name">Bobby</div>
        <div id="charPreviewBonus" class="cp-bonus">brak bonusÃ³w</div>
      </div>
    </div>

    <!-- Horizontal character picker -->
    <div id="charPicker"
      style="display:flex;overflow-x:auto;gap:8px;padding:4px 2px;
             width:100%;max-width:280px;margin-bottom:18px;
             -webkit-overflow-scrolling:touch">
    </div>

    <button id="lobbyPlay" class="btn btn-yellow">â–¶ GRAJ</button>
    <button id="lobbyShop" class="btn btn-blue">ğŸ›’ SKLEP</button>
  </div>
</div>

<!-- â”€â”€ Shop screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="shopScreen" class="screen" style="display:none">
  <div class="screen-inner" style="justify-content:flex-start;padding-top:20px">
    <div class="shop-header">
      <button id="shopBack" class="btn btn-dark btn-sm">â† WRÃ“Ä†</button>
      <div id="shopCoins" class="coins" style="margin:0">ğŸµ 0</div>
    </div>
    <div id="shopGrid" class="shop-grid"></div>
  </div>
</div>

<!-- â”€â”€ DOM HUD overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="hud" style="position:fixed;top:0;left:0;width:100%;pointer-events:none;z-index:10;display:none">
  <span id="hudCoins" style="position:absolute;top:10px;left:10px;color:#ffd700;font:bold 15px Arial">\uD83C\uDFB50</span>
  <span id="hudScore" style="position:absolute;top:6px;right:10px;color:#fff;font:bold 28px Arial">0</span>
  <span id="hudHeart" style="position:absolute;top:30px;left:10px;font:15px Arial"></span>
</div>

<!-- â”€â”€ Game canvas (hidden until game starts) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<canvas id="gameCanvas" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) translateZ(0)"></canvas>

<script type="module">
// â”€â”€ Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, collection, doc,
         getDoc, setDoc, getDocs,
         query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey:            "AIzaSyCv02h10zIVw8DhrBhryiDnFIa_peZklKQ",
  authDomain:        "flappy-bobby.firebaseapp.com",
  projectId:         "flappy-bobby",
  storageBucket:     "flappy-bobby.firebasestorage.app",
  messagingSenderId: "79131027037",
  appId:             "1:79131027037:web:2224f6d16ef4f7e6a88fb4"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// â”€â”€ Leaderboard cache canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const lbCacheCanvas = document.createElement('canvas');
const lbCtx = lbCacheCanvas.getContext('2d');
let lbCacheReady = false;

// â”€â”€ Character definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CHARACTERS = {
  bobby:    { name:'Bobby',     img:'bobby.png',    price:0,    col:'soundcloud.png',
              bonuses:[],                              desc:'brak bonusÃ³w' },
  bialek:   { name:'Bialek',    img:'bialek.png',   price:50,   col:'nina.png',
              bonuses:['gap+10'],                     desc:'przelot +10px' },
  deadman:  { name:'Deadman',   img:'deadman.png',  price:100,  col:'grammy.png',
              bonuses:['speed-5'],                    desc:'rury âˆ’5%' },
  krystian: { name:'Krystian',  img:'krystian.png', price:200,  col:'diormind.png',
              bonuses:['extralife'],                  desc:'+1 Å¼ycie' },
  johnny:   { name:'Johnny',    img:'johnny.png',   price:350,  col:'joint.png',
              bonuses:['gap+10','speed-5'],           desc:'przelot +10px, rury âˆ’5%' },
  kolin:    { name:'Kolin',     img:'kolin.png',    price:500,  col:'strzykawka.png',
              bonuses:['gap+20'],                     desc:'przelot +20px' },
  kutasa:   { name:'Kutasa',    img:'kutasa.png',   price:750,  col:'dziecko.png',
              bonuses:['speed-10','extralife'],       desc:'rury âˆ’10%, +1 Å¼ycie' },
  reczu:    { name:'Reczu',     img:'reczu.png',    price:1000, col:'kutas.png',
              bonuses:['gap+20','speed-10'],          desc:'przelot +20px, rury âˆ’10%' },
  szpachl:  { name:'Szpachl',   img:'szpachl.png',  price:1500, col:'scat.png',
              bonuses:['double'],                     desc:'Ã—2 punkty i monety' },
  tom:      { name:'Tom',       img:'tom.png',      price:2000, col:'wozek.png',
              bonuses:['extralife','double','speed-5'], desc:'+Å¼ycie, Ã—2 pkt, rury âˆ’5%' },
  majka:    { name:'Majka ğŸ‘‘',  img:'majka.png',    price:3500, col:'onlyfans.png',
              bonuses:['gap+30','speed-15','double','extralife'],
              desc:'WSZYSTKO: âˆ’15%, +30px, Ã—2, +Å¼ycie', special:true },
};
const CHAR_KEYS = Object.keys(CHARACTERS);

// â”€â”€ Firestore helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPlayerData(nick, pin) {
  try {
    const snap = await getDoc(doc(db, 'leaderboard', nick));
    if (snap.exists()) {
      const d = snap.data();
      if (d.pin && d.pin !== pin) return { error: 'invalid_pin' };
      if (!d.pin) await setDoc(doc(db, 'leaderboard', nick), { pin }, { merge: true });
      let skins = d.unlockedSkins;
      if (!Array.isArray(skins)) {
        if (typeof skins === 'string') { try { skins = JSON.parse(skins); } catch { skins = ['bobby']; } }
        if (!Array.isArray(skins)) skins = ['bobby'];
      }
      return { coins: d.coins ?? 0, unlockedSkins: skins, activeSkin: d.activeSkin ?? 'bobby', score: d.score ?? 0 };
    } else {
      await setDoc(doc(db, 'leaderboard', nick), {
        nick, score: 0, coins: 0, unlockedSkins: ['bobby'], activeSkin: 'bobby', pin, date: new Date()
      });
    }
  } catch(e) { console.warn('loadPlayerData:', e); }
  return { coins: 0, unlockedSkins: ['bobby'], activeSkin: 'bobby', score: 0 };
}

async function saveProgress(roundScore = playerBestScore) {
  try {
    if (roundScore > playerBestScore) playerBestScore = roundScore;
    const ref = doc(db, 'leaderboard', playerNick);
    await setDoc(ref, {
      nick: playerNick, score: playerBestScore, date: new Date(),
      coins: playerCoins, unlockedSkins, activeSkin, pin: playerPin
    }, { merge: true });
  } catch(e) { console.warn('saveProgress:', e); }
}

async function getTopScores() {
  try {
    const snap = await getDocs(
      query(collection(db, 'leaderboard'), orderBy('score','desc'), limit(10))
    );
    return snap.docs.map(d => d.data());
  } catch(e) { console.warn('getTopScores:', e); return []; }
}

// â”€â”€ Canvas & DPR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas = document.getElementById('gameCanvas');
const ctx    = canvas.getContext('2d');
const GW = 400, GH = 600;
const isMobile = window.innerWidth < 600;
const dpr = Math.min(window.devicePixelRatio || 1, isMobile ? 1.5 : 2);
canvas.width  = Math.round(GW * dpr);
canvas.height = Math.round(GH * dpr);
canvas.style.imageRendering = 'auto';
ctx.scale(dpr, dpr);

let canvasRect = { left: 0, top: 0, width: GW, height: GH };
const _touchPos = { x: 0, y: 0 };

function resize() {
  const s = Math.min(window.innerWidth / GW, window.innerHeight / GH);
  canvas.style.width  = (GW * s) + 'px';
  canvas.style.height = (GH * s) + 'px';
  setTimeout(() => { canvasRect = canvas.getBoundingClientRect(); }, 0);
}
window.addEventListener('resize', resize);

// â”€â”€ Base constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GRAVITY = 0.45, JUMP_FORCE = -9.5, PIPE_SPEED = 2.55;
const PIPE_GAP = 175, PIPE_WIDTH = 72, PIPE_INTERVAL = 1750;
const BIRD_SIZE = 60, COL_W = 70;

// â”€â”€ Pre-rendered background (stars) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STARS = Array.from({ length: 25 }, () => ({
  x: Math.random() * GW, y: Math.random() * GH * 0.75,
  r: Math.random() < 0.3 ? 1.5 : 1
}));
const bgCacheCanvas = document.createElement('canvas');
const bgCtx = bgCacheCanvas.getContext('2d');
const uiCacheCanvas = document.createElement('canvas');
let uiCacheReady = false;

function buildUICache() {
  uiCacheCanvas.width = GW; uiCacheCanvas.height = GH;
  const uctx = uiCacheCanvas.getContext('2d');
  uctx.font = 'bold 52px Arial'; uctx.fillStyle = '#ffd700'; uctx.textAlign = 'center';
  uctx.fillText('Bobby Bird', GW/2, GH/4+10);
  const b = SHOP_BTN;
  uctx.fillStyle = '#1a6aff'; uctx.beginPath(); uctx.roundRect(b.x, b.y, b.w, b.h, 12); uctx.fill();
  uctx.font = 'bold 18px Arial'; uctx.fillStyle = '#fff';
  uctx.fillText('\uD83D\uDED2 SKLEP', b.x + b.w/2, b.y + b.h/2 + 7);
  uiCacheReady = true;
}
function renderBackgroundToCache() {
  bgCacheCanvas.width = GW; bgCacheCanvas.height = GH;
  bgCtx.fillStyle = '#0f1432';
  bgCtx.fillRect(0, 0, GW, GH);
  bgCtx.fillStyle = '#b4c8ff';
  for (const s of STARS) { bgCtx.beginPath(); bgCtx.arc(s.x, s.y, s.r, 0, Math.PI*2); bgCtx.fill(); }
}
renderBackgroundToCache();

// â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Background music â€” HTMLAudioElement (streaming)
const bgMusic = new Audio('assets/sounds/music.mp3');
bgMusic.loop = true; bgMusic.volume = 0.3;
function startMusic() { bgMusic.currentTime = 0; bgMusic.play().catch(e => console.warn('music blocked:', e)); }
function stopMusic()  { bgMusic.pause(); }

// Sound effects â€” Web Audio API (low-latency, no pool needed)
const _AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new _AudioContext();
const audioBuffers = {};

async function loadAudioBuffer(key, url) {
  try {
    const res = await fetch(url);
    const arr = await res.arrayBuffer();
    audioBuffers[key] = await audioCtx.decodeAudioData(arr);
  } catch(e) { console.warn('Audio load error:', key, e); }
}

function playSound(key, vol = 1.0) {
  if (!audioBuffers[key]) return;
  const src = audioCtx.createBufferSource();
  src.buffer = audioBuffers[key];
  const gain = audioCtx.createGain();
  gain.gain.value = vol;
  src.connect(gain);
  gain.connect(audioCtx.destination);
  src.start(0);
}

const playKaching  = () => playSound('kaching',  0.5);
const playMumia    = () => playSound('mumia',    1.0);
const playDzwiek7  = () => playSound('dzwiek7',  1.0);
const playKrystian = () => playSound('krystian', 1.0);

loadAudioBuffer('kaching',  'assets/sounds/kaching.wav');
loadAudioBuffer('mumia',    'assets/sounds/mumia.mp3');
loadAudioBuffer('dzwiek7',  'assets/sounds/7.mp3');
loadAudioBuffer('krystian', 'assets/sounds/krystian.mp3');

function playSpecialSound(sc) {
  if (sc <= 0) return;
  if      (sc % 100 === 0) playKrystian();
  else if (sc % 10  === 0) playMumia();
  else if (sc % 10  === 7) playDzwiek7();
}

// â”€â”€ Image helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadImage(src) {
  return new Promise(resolve => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload  = () => resolve(img);
    img.onerror = () => { console.warn('Failed to load image:', src); resolve(null); };
    img.src = src;
  });
}
// Per-skin caches
const spriteCache     = {}; // key â†’ Image
const collectCache    = {}; // key â†’ { img, h }

async function ensureSprite(key) {
  if (spriteCache[key] !== undefined) return;
  spriteCache[key] = await loadImage(`assets/characters/${CHARACTERS[key].img}`);
}
async function ensureCollectible(key) {
  if (collectCache[key] !== undefined) return;
  const img = await loadImage(`assets/collectibles/${CHARACTERS[key].col}`);
  if (img) {
    const h = Math.max(1, Math.round(img.naturalHeight * COL_W / img.naturalWidth));
    collectCache[key] = { img, h };
  } else {
    collectCache[key] = null;
  }
}

// Active skin assets (set in applyActiveSkin)
let playerImg       = null;
let collectImg      = null;
let collectH        = COL_W;

async function applyActiveSkin(key) {
  await ensureSprite(key);
  await ensureCollectible(key);
  playerImg   = spriteCache[key] || null;
  const c = collectCache[key];
  collectImg  = c ? c.img : null;
  collectH    = c ? c.h   : COL_W;
}

// â”€â”€ Player state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let playerNick    = '';
let playerCoins   = 0;
let unlockedSkins = ['bobby'];
let activeSkin      = 'bobby';
let playerBestScore = 0; // PamiÄ™Ä‡ RAM dla najlepszego wyniku
let playerPin       = '';

// â”€â”€ Session params (computed from active skin) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let S_GAP = PIPE_GAP, S_SPEED = PIPE_SPEED, S_DOUBLE = false, S_EXTRA = false;
let S_INTERVAL = PIPE_INTERVAL;

function computeSessionParams() {
  const b = CHARACTERS[activeSkin].bonuses;
  S_GAP    = PIPE_GAP + (b.includes('gap+30') ? 30 : b.includes('gap+20') ? 20 : b.includes('gap+10') ? 10 : 0);
  S_SPEED  = PIPE_SPEED * (b.includes('speed-15') ? 0.85 : b.includes('speed-10') ? 0.90 : b.includes('speed-5') ? 0.95 : 1);
  S_DOUBLE = b.includes('double');
  S_EXTRA  = b.includes('extralife');
  S_INTERVAL = PIPE_INTERVAL * (PIPE_SPEED / S_SPEED);
}

// â”€â”€ Extra life â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let extraLifeAvail = false;
let flashUntil     = 0;

// â”€â”€ Globalne zmienne stanu (BrakujÄ…ce deklaracje) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let leaderboard          = [];
let leaderboardLoading   = false;
let cachedLeaderboard    = [];
let lastLeaderboardFetch = 0;
const _cr = { x: 0, y: 0, w: 0, h: 0 };
const _pr = { x: 0, y: 0, w: 0, h: 0 };

// â”€â”€ Screen management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nickScreen  = document.getElementById('nickScreen');
const lobbyScreen = document.getElementById('lobbyScreen');
const shopScreen  = document.getElementById('shopScreen');

// â”€â”€ DOM HUD elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const hudEl      = document.getElementById('hud');
const hudCoinsEl = document.getElementById('hudCoins');
const hudScoreEl = document.getElementById('hudScore');
const hudHeartEl = document.getElementById('hudHeart');
let _hud_coins = -1, _hud_score = -1, _hud_extra = null;

function updateHUD(currentScore) {
  if (_hud_coins !== playerCoins) {
    _hud_coins = playerCoins;
    hudCoinsEl.textContent = '\uD83C\uDFB5' + playerCoins;
  }
  if (_hud_score !== currentScore) {
    _hud_score = currentScore;
    hudScoreEl.textContent = currentScore;
  }
  const heartState = S_EXTRA ? (extraLifeAvail ? '\u2665' : '\u2661') : '';
  if (_hud_extra !== heartState) {
    _hud_extra = heartState;
    hudHeartEl.textContent = heartState;
    hudHeartEl.style.color = (S_EXTRA && extraLifeAvail) ? '#dc3232' : '#444';
  }
}

let isGameCanvasVisible = false;

function hideAll() {
  nickScreen.style.display = lobbyScreen.style.display =
  shopScreen.style.display = canvas.style.display =
  hudEl.style.display = 'none';
  isGameCanvasVisible = false;
}
function showLobby() {
  hideAll();
  lobbyScreen.style.display = 'flex';
  updateLobbyUI();
}
function showShop() {
  hideAll();
  shopScreen.style.display = 'flex';
  renderShop();
}
function showGame() {
  hideAll();
  canvas.style.display = hudEl.style.display = 'block';
  isGameCanvasVisible = true;
  resize();
  startGameLoop();
}

// â”€â”€ Nick screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nickInput   = document.getElementById('nickInput');
const pinInput    = document.getElementById('pinInput');
const loginError  = document.getElementById('loginError');
const nickConfirm = document.getElementById('nickConfirm');
let nickDone = false;

async function onNickConfirm() {
  if (nickDone) return;
  const val = nickInput.value.trim();
  const pin = pinInput.value.trim();

  if (!val) { nickInput.classList.add('error'); return; }
  if (!pin || pin.length < 4) { pinInput.classList.add('error'); return; }

  nickInput.classList.remove('error');
  pinInput.classList.remove('error');
  loginError.style.display = 'none';

  const data = await loadPlayerData(val, pin);
  if (data.error === 'invalid_pin') {
    loginError.style.display = 'block';
    return;
  }

  nickDone = true;
  playerNick = val.slice(0, 16);
  playerPin  = pin;

  playerCoins     = data.coins;
  unlockedSkins   = data.unlockedSkins;
  playerBestScore = data.score;
  if (!unlockedSkins.includes('bobby')) unlockedSkins.push('bobby');
  activeSkin = unlockedSkins.includes(data.activeSkin) ? data.activeSkin : 'bobby';

  await applyActiveSkin(activeSkin);
  showLobby();
}

nickConfirm.addEventListener('click',    onNickConfirm);
nickConfirm.addEventListener('touchend', e => { e.preventDefault(); onNickConfirm(); });
nickInput.addEventListener('keydown', e => { if (e.key === 'Enter') onNickConfirm(); e.stopPropagation(); });
nickInput.focus();

// â”€â”€ Lobby UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateLobbyUI() {
  document.getElementById('lobbyNick').textContent        = playerNick;
  document.getElementById('lobbyCoins').textContent       = '\uD83C\uDFB5 ' + playerCoins + ' coin\xF3w';
  document.getElementById('charPreviewName').textContent  = CHARACTERS[activeSkin].name;
  document.getElementById('charPreviewBonus').textContent = CHARACTERS[activeSkin].desc;
  document.getElementById('charPreviewImg').src           = `assets/characters/${CHARACTERS[activeSkin].img}`;
  renderCharPicker();
}

function renderCharPicker() {
  const bar = document.getElementById('charPicker');
  if (!bar) return;
  bar.innerHTML = '';
  CHAR_KEYS.forEach(key => {
    const ch     = CHARACTERS[key];
    const owned  = unlockedSkins.includes(key);
    const active = activeSkin === key;

    const wrap = document.createElement('div');
    wrap.style.cssText =
      `flex-shrink:0;position:relative;border-radius:8px;
       border:2px solid ${active ? '#ffd700' : 'transparent'};
       opacity:${owned ? 1 : 0.4};
       cursor:${owned ? 'pointer' : 'default'};
       touch-action:manipulation;`;

    const img = document.createElement('img');
    img.src = `assets/characters/${ch.img}`;
    img.alt = ch.name;
    img.title = ch.name;
    img.style.cssText = 'width:50px;height:50px;object-fit:cover;border-radius:6px;display:block;background:#0f1432';

    wrap.appendChild(img);

    if (!owned) {
      const lock = document.createElement('div');
      lock.style.cssText =
        'position:absolute;inset:0;display:flex;align-items:center;' +
        'justify-content:center;font-size:16px;pointer-events:none;border-radius:6px;' +
        'background:rgba(0,0,0,.35)';
      lock.textContent = '\uD83D\uDD12';
      wrap.appendChild(lock);
    }

    if (owned) {
      let pGuard = false;
      async function pickChar(e) {
        if (e) e.preventDefault();
        if (pGuard || activeSkin === key) return;
        pGuard = true;
        activeSkin = key;
        await applyActiveSkin(key);
        await saveProgress();
        updateLobbyUI();
      }
      wrap.addEventListener('click',    pickChar);
      wrap.addEventListener('touchend', pickChar);
    }

    bar.appendChild(wrap);
  });
}

let lobbyPlayGuard = false;
async function onLobbyPlay() {
  if (lobbyPlayGuard) return;
  lobbyPlayGuard = true;
  computeSessionParams();
  await applyActiveSkin(activeSkin);
  SceneManager.changeScene(FlappyMode);
  showGame();
  setTimeout(() => { lobbyPlayGuard = false; }, 500);
}

const lobbyPlay = document.getElementById('lobbyPlay');
const lobbyShop = document.getElementById('lobbyShop');
lobbyPlay.addEventListener('click',    onLobbyPlay);
lobbyPlay.addEventListener('touchend', e => { e.preventDefault(); onLobbyPlay(); });
lobbyShop.addEventListener('click',    () => showShop());
lobbyShop.addEventListener('touchend', e => { e.preventDefault(); showShop(); });

// â”€â”€ Shop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onShopBack() {
  if (shopFromWaiting) {
    shopFromWaiting = false;
    computeSessionParams(); SceneManager.changeScene(FlappyMode);
    hideAll();
    canvas.style.display = hudEl.style.display = 'block';
    isGameCanvasVisible = true;
    resize();
  } else { showLobby(); }
}
document.getElementById('shopBack').addEventListener('click',    () => onShopBack());
document.getElementById('shopBack').addEventListener('touchend', e => { e.preventDefault(); onShopBack(); });

function renderShop() {
  document.getElementById('shopCoins').textContent = 'ğŸµ ' + playerCoins;
  const grid = document.getElementById('shopGrid');
  if (!grid) { console.error('[Shop] shopGrid element not found!'); return; }
  grid.innerHTML = '';

  CHAR_KEYS.forEach(key => {
    const ch       = CHARACTERS[key];
    const owned    = unlockedSkins.includes(key);
    const isActive = activeSkin === key;
    const canBuy   = !owned && playerCoins >= ch.price;
    const card = document.createElement('div');
    card.className = 'char-card' + (isActive ? ' active-card' : '') + (ch.special ? ' majka-card' : '');

    const img = document.createElement('img');
    img.src = `assets/characters/${ch.img}`;
    img.alt = ch.name;
    img.onerror = () => { img.style.opacity = '.3'; };

    const name = document.createElement('div');
    name.className = 'cc-name'; name.textContent = ch.name;

    const bonuses = document.createElement('div');
    bonuses.className = 'cc-bonuses'; bonuses.textContent = ch.desc;

    const btn = document.createElement('button');
    btn.className = 'cc-btn ' + (isActive ? 'active' : owned ? 'select' : canBuy ? 'buy' : 'locked');
    btn.textContent = isActive ? 'âœ“ AKTYWNA'
                    : owned    ? 'WYBIERZ'
                    : canBuy   ? `KUP \uD83C\uDFB5${ch.price}`
                    :            `\uD83D\uDD12 ${ch.price}\uD83C\uDFB5`;
    if (isActive || (!owned && !canBuy)) btn.disabled = true;

    let guard = false;
    async function doAction(e) {
      if (e) e.preventDefault();
      if (guard) return;
      guard = true;
      if (owned) {
        activeSkin = key;
        await applyActiveSkin(key);
        await saveProgress();
        renderShop();
        updateLobbyUI();
      } else {
        if (playerCoins < ch.price) { console.warn('[Shop] not enough coins'); guard = false; return; }
        playerCoins   -= ch.price;
        unlockedSkins.push(key);
        activeSkin     = key;
        await applyActiveSkin(key);
        await saveProgress();
        renderShop();
        updateLobbyUI();
      }
    }
    btn.addEventListener('click',    doAction);
    btn.addEventListener('touchend', doAction);

    card.append(img, name, bonuses, btn);
    grid.appendChild(card);
  });
}

// â”€â”€ Scene Manager (Maszyna StanÃ³w) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SceneManager = {
  activeScene: null,

  changeScene(newScene) {
    if (this.activeScene && this.activeScene.cleanup) this.activeScene.cleanup();
    this.activeScene = newScene;
    if (this.activeScene.init) this.activeScene.init();
  },

  update(dt) {
    if (this.activeScene && this.activeScene.update) this.activeScene.update(dt);
  },

  draw() {
    if (this.activeScene && this.activeScene.draw) this.activeScene.draw();
  },

  onAction(px, py) {
    if (this.activeScene && this.activeScene.onAction) this.activeScene.onAction(px, py);
  }
};

// â”€â”€ KartridÅ¼ 1: Flappy Mode (Klasyczny Bobby Bird) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FlappyMode = {
  state: 'waiting',
  score: 0,
  pipeTimer: 0,
  gameOverAt: 0,
  pipePool: Array.from({ length: 6 }, () => ({
    active: false, x: 0, topH: 0, botY: 0, passed: false, collected: false
  })),

  // Hermetyzacja ptaka tylko dla tego trybu
  bird: {
    x: 80, y: 300, vy: 0,
    _r: { x: 0, y: 0, w: BIRD_SIZE - 4, h: BIRD_SIZE - 4 },
    jump()     { this.vy = JUMP_FORCE; },
    update(dt) {
      const f = dt / 16.667;
      const deltaY = this.vy * f + 0.5 * GRAVITY * f * f;
      this.vy += GRAVITY * f;
      this.y  += deltaY;
    },
    rect() { this._r.x = this.x + 2; this._r.y = this.y + 2; return this._r; }
  },

  // Inicjalizacja sesji (ZastÄ™puje initNewSession i resetGame)
  init() {
    this.resetState();
    stopMusic();
    updateHUD(this.score); // Inicjalizacja HUD
  },

  resetState() {
    this.bird.x = 80; this.bird.y = GH/2; this.bird.vy = 0;
    this.pipePool.forEach(p => p.active = false);
    this.pipeTimer = 0;
    this.score = 0;
    leaderboard = [];
    leaderboardLoading = false;
    lbCacheReady = false;
    extraLifeAvail = S_EXTRA;
    flashUntil = 0;
    this.state = 'waiting';
  },

  startGame() {
    this.state = 'playing';
    this.bird.jump();
    startMusic();
  },

  async die() {
    if (extraLifeAvail) {
      extraLifeAvail = false;
      flashUntil = performance.now() + 1500;
      this.bird.vy = JUMP_FORCE;
      return;
    }
    stopMusic();
    this.gameOverAt = performance.now();
    this.state = 'gameover';
    leaderboardLoading = true;
    leaderboard = [];

    saveProgress(this.score);

    if (this.score > playerBestScore) {
      playerBestScore = this.score;
      const existingMe = cachedLeaderboard.find(e => e.nick === playerNick);
      if (existingMe) existingMe.score = this.score;
      else cachedLeaderboard.push({ nick: playerNick, score: this.score });
      cachedLeaderboard.sort((a, b) => b.score - a.score);
      cachedLeaderboard = cachedLeaderboard.slice(0, 10);
    }

    const now = performance.now();
    if (now - lastLeaderboardFetch > 60000 || cachedLeaderboard.length === 0) {
      cachedLeaderboard = await getTopScores();
      lastLeaderboardFetch = now;
    }

    leaderboard = cachedLeaderboard;
    leaderboardLoading = false;
    this.renderLeaderboardCache();
  },

  renderLeaderboardCache() {
    lbCacheCanvas.width = GW; lbCacheCanvas.height = 300;
    lbCtx.clearRect(0, 0, GW, 300);
    if (!leaderboard.length) {
      txt(lbCtx, 'Brak wynikÃ³w', GW/2, 22, '13px Arial', '#888', 'center');
    } else {
      leaderboard.forEach((e, i) => {
        const ry = 20 + i * 22;
        const color = e.nick === playerNick ? '#ffd700' : (i < 3 ? '#fff' : '#909090');
        txt(lbCtx, `${i+1}. ${e.nick}`, 22, ry, '13px Arial', color, 'left');
        txt(lbCtx, String(e.score), GW-22, ry, '13px Arial', color, 'right');
      });
    }
    lbCacheReady = true;
  },

  spawnPipe() {
    const p = this.pipePool.find(pipe => !pipe.active);
    if (!p) return;
    const gc = GH/4 + Math.random() * (GH/2);
    p.active = true; p.x = GW;
    p.topH = gc - S_GAP/2; p.botY = gc + S_GAP/2;
    p.passed = false; p.collected = false;
  },

  update(dt) {
    if (this.state === 'gameover' || this.state !== 'playing') return;

    this.bird.update(dt);
    this.pipeTimer += dt;
    if (this.pipeTimer >= S_INTERVAL) { this.spawnPipe(); this.pipeTimer = 0; }

    const f = dt / 16.667;
    const br = this.bird.rect();

    const isInvincible = performance.now() < flashUntil;

    for (let i = 0; i < this.pipePool.length; i++) {
      const p = this.pipePool[i];
      if (!p.active) continue;

      p.x -= S_SPEED * f;
      if (!p.passed && p.x + PIPE_WIDTH < this.bird.x) p.passed = true;
      if (p.x + PIPE_WIDTH <= 0) { p.active = false; continue; }

      if (!p.collected) {
        _cr.x = p.x + PIPE_WIDTH/2 - COL_W/2;
        _cr.y = (p.topH + p.botY)/2 - collectH/2;
        _cr.h = collectH;
        if (overlaps(br, _cr)) {
          p.collected = true;
          const pts = S_DOUBLE ? 2 : 1;
          this.score += pts; playerCoins += pts;
          playKaching(); playSpecialSound(this.score);
        }
      }

      if (!isInvincible) {
        _pr.x = p.x; _pr.y = 0; _pr.h = p.topH;
        if (overlaps(br, _pr)) { this.die(); return; }
        _pr.y = p.botY; _pr.h = GH - p.botY;
        if (overlaps(br, _pr)) { this.die(); return; }
      }
    }

    if (this.bird.y > GH || this.bird.y < -BIRD_SIZE) { this.die(); return; }
  },

  draw() {
    if (this.state === 'waiting') {
      ctx.globalAlpha = 0.65;
      ctx.drawImage(bgCacheCanvas, 0, 0);
      ctx.globalAlpha = 1.0;
    } else {
      ctx.drawImage(bgCacheCanvas, 0, 0);
    }

    ctx.fillStyle = '#22b422';
    for (const p of this.pipePool) {
      if (!p.active) continue;
      if (p.topH > 0) ctx.fillRect(p.x, 0, PIPE_WIDTH, p.topH);
      if (p.botY < GH) ctx.fillRect(p.x, p.botY, PIPE_WIDTH, GH - p.botY);
    }

    ctx.fillStyle = '#127812';
    const _cap = 28, _bw = PIPE_WIDTH + 20;
    for (const p of this.pipePool) {
      if (!p.active) continue;
      const bx = p.x - 10;
      if (p.topH > 0) ctx.fillRect(bx, p.topH - _cap, _bw, _cap);
      if (p.botY < GH) ctx.fillRect(bx, p.botY, _bw, _cap);
    }

    if (collectImg) {
      for (const p of this.pipePool) {
        if (p.active && !p.collected)
          ctx.drawImage(collectImg, p.x+PIPE_WIDTH/2-COL_W/2, (p.topH+p.botY)/2-collectH/2, COL_W, collectH);
      }
    }

    if (this.state !== 'waiting') {
      const isInvincible = performance.now() < flashUntil;
      if (!isInvincible || ((performance.now() / 150) | 0) % 2 === 0) {
        drawBirdAt(this.bird.x, this.bird.y, Math.max(-35, Math.min(50, -this.bird.vy*3)));
      }
    }

    updateHUD(this.score);

    if (this.state === 'waiting') this.drawWaiting();
    else if (this.state === 'gameover') this.drawGameOver();
  },

  drawWaiting() {
    if (!uiCacheReady) buildUICache();
    ctx.drawImage(uiCacheCanvas, 0, 0);
    const hy = GH/2 - BIRD_SIZE/2 + Math.sin(performance.now()/333)*12;
    drawBirdAt(GW/2 - BIRD_SIZE/2, hy, 0);
    if (((performance.now() / 600) | 0) % 2 === 0) {
      txt(ctx, 'Tap lub SPACJA aby zaczÄ…Ä‡', GW/2, GH*2/3+10, 'bold 20px Arial', '#fff');
    }
  },

  drawGameOver() {
    overlay(0.62);
    txt(ctx, 'GAME OVER', GW/2, 72, 'bold 44px Arial', '#dc3232');
    txt(ctx, 'Score: '+this.score, GW/2, 108, 'bold 26px Arial', '#ffd700');
    ctx.strokeStyle='#444'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(20,122); ctx.lineTo(GW-20,122); ctx.stroke();

    txt(ctx, '\uD83C\uDFC6 TOP 10', GW/2, 138, 'bold 15px Arial', '#ffd700');
    if (leaderboardLoading) txt(ctx, 'Åadowanie...', GW/2, 138+22, '13px Arial', '#888');
    else if (lbCacheReady) ctx.drawImage(lbCacheCanvas, 0, 138);

    ctx.beginPath(); ctx.moveTo(20,380); ctx.lineTo(GW-20,380); ctx.stroke();
    const canRestart = (performance.now() - this.gameOverAt) > 1000;
    txt(ctx, canRestart ? 'Tapnij, aby zagraÄ‡ ponownie' : 'Czekaj...', GW/2, 402, '15px Arial', canRestart ? '#fff' : '#555');
  },

  onAction(px, py) {
    if (this.state === 'waiting' && px !== undefined && hitShopBtn(px, py)) {
      showShopFromWaiting(); return;
    }
    if (this.state === 'waiting')  { this.startGame(); return; }
    if (this.state === 'playing')  { this.bird.jump(); return; }
    if (this.state === 'gameover') {
      if (performance.now() - this.gameOverAt > 1000) this.resetState();
      return;
    }
  }
};

// â”€â”€ ModuÅ‚y pomocnicze dla scen (dawne funkcje globalne) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function overlaps(a, b) {
  return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
}
function txt(context, str, x, y, font, color, align = 'center') {
  context.font = font; context.fillStyle = color; context.textAlign = align;
  context.fillText(str, x, y);
}
function overlay(a) { ctx.fillStyle = `rgba(0,0,0,${a})`; ctx.fillRect(0, 0, GW, GH); }
const SHOP_BTN = { x: GW - 120, y: GH - 80, w: 110, h: 64 };

function hitShopBtn(px, py) {
  const b = SHOP_BTN;
  return px >= b.x && px <= b.x + b.w && py >= b.y && py <= b.y + b.h;
}

function drawBirdAt(x, y, angle) {
  if (!playerImg) return;
  ctx.save();
  ctx.translate(x + BIRD_SIZE/2, y + BIRD_SIZE/2);
  ctx.rotate(angle * Math.PI / 180);
  ctx.drawImage(playerImg, -BIRD_SIZE/2, -BIRD_SIZE/2, BIRD_SIZE, BIRD_SIZE);
  ctx.restore();
}

let shopFromWaiting = false;
function showShopFromWaiting() { shopFromWaiting = true; showShop(); }

// â”€â”€ Input Delegator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function canvasXY(e) {
  const cx = (e.clientX ?? e.touches?.[0]?.clientX ?? 0) - canvasRect.left;
  const cy = (e.clientY ?? e.touches?.[0]?.clientY ?? 0) - canvasRect.top;
  _touchPos.x = cx / canvasRect.width * GW;
  _touchPos.y = cy / canvasRect.height * GH;
  return _touchPos;
}

document.addEventListener('keydown', e => {
  if (e.code === 'Space') { e.preventDefault(); SceneManager.onAction(); }
});

canvas.addEventListener('pointerdown', e => {
  if (e.pointerType === 'mouse' && e.button !== 0) return;
  e.preventDefault();
  const p = canvasXY(e);
  SceneManager.onAction(p.x, p.y);
});

// â”€â”€ Game loop (starts once, runs forever) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastTime = performance.now(), loopRunning = false;

function loop(now) {
  if (!loopRunning) return;
  requestAnimationFrame(loop);
  let dt = now - lastTime;
  lastTime = now;
  if (dt > 50) dt = 50;
  if (isGameCanvasVisible) {
    SceneManager.update(dt);
    SceneManager.draw();
  }
}

function startGameLoop() {
  if (loopRunning) return;
  loopRunning = true;
  lastTime = performance.now();
  requestAnimationFrame(loop);
}

document.addEventListener('visibilitychange', () => {
  lastTime = performance.now();
  if (document.hidden) {
    if (audioCtx.state === 'running') audioCtx.suspend();
    bgMusic.pause();
  } else {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    if (SceneManager.activeScene && SceneManager.activeScene.state === 'playing') {
      bgMusic.play().catch(() => {});
    }
  }
});

// â”€â”€ Audio prewarm â€” unlock AudioContext on first user gesture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let audioUnlocked = false;
function unlockAudioOnFirstTouch() {
  if (audioUnlocked) return;
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const silence = new Audio();
  silence.src = 'data:audio/mp3;base64,//OExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq';
  silence.play().catch(() => {});
  audioUnlocked = true;
}
document.addEventListener('touchstart', unlockAudioOnFirstTouch, { once: true });
document.addEventListener('mousedown',  unlockAudioOnFirstTouch, { once: true });

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('Service Worker zarejestrowany.', reg.scope))
      .catch(err => console.warn('Rejestracja Service Workera nie powiodÅ‚a siÄ™:', err));
  });
}
</script>
</body>
</html>
