<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Bobby Bird</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0a0a2e" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Bobby Bird" />
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%; height: 100%;
      background: #0a0a2e;
      font-family: Arial, sans-serif;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    canvas {
      display: block; touch-action: none; user-select: none;
      will-change: transform; transform: translateZ(0);
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }

    /* â”€â”€ Shared screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .screen {
      position: fixed; inset: 0;
      background: #0a0a2e;
      display: flex; flex-direction: column; align-items: center;
      overflow-y: auto; -webkit-overflow-scrolling: touch;
      z-index: 100;
    }
    .screen-inner {
      width: 100%; max-width: 500px;
      padding: 32px 20px;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100%;
      justify-content: center;
    }
    .screen-title  { color: #ffd700; font-size: 2.2em; font-weight: bold; margin-bottom: 6px; text-align: center; }
    .screen-sub    { color: #aaa; font-size: .88rem; margin-bottom: 24px; text-align: center; }

    /* â”€â”€ Inputs / Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .big-input {
      width: 80%; max-width: 280px; height: 58px;
      font-size: 16px; padding: 0 16px; text-align: center;
      border: 2px solid #ffd700; border-radius: 10px;
      background: #0f1432; color: #fff; outline: none;
      margin-bottom: 14px;
    }
    .big-input.error { border-color: #dc3232; }
    .btn {
      display: flex; align-items: center; justify-content: center;
      width: 80%; max-width: 280px; height: 56px;
      font-size: 1.1rem; font-weight: bold;
      border: none; border-radius: 10px; cursor: pointer;
      touch-action: manipulation; margin-bottom: 10px;
      transition: filter .12s;
    }
    .btn:active { filter: brightness(.82); }
    .btn-yellow { background: #ffd700; color: #0f1432; }
    .btn-blue   { background: #1a6aff; color: #fff; }
    .btn-dark   { background: #1e1e4a; color: #aaa; border: 1px solid #333; }
    .btn-sm     { height: 40px; font-size: .88rem; width: auto; padding: 0 18px; margin-bottom: 0; }

    /* â”€â”€ Coins badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .coins { color: #ffd700; font-size: 1.05rem; margin-bottom: 16px; }

    /* â”€â”€ Character preview (lobby) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .char-preview {
      display: flex; align-items: center; gap: 12px;
      background: #131340; border: 1px solid #2a2a6a;
      border-radius: 12px; padding: 10px 14px;
      margin-bottom: 20px; width: 80%; max-width: 280px;
    }
    .char-preview img { width: 48px; height: 48px; object-fit: cover; border-radius: 8px; background: #0f1432; }
    .cp-name  { color: #fff; font-weight: bold; font-size: .9rem; }
    .cp-bonus { color: #8be; font-size: .72rem; margin-top: 2px; }

    /* â”€â”€ Shop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .shop-header {
      display: flex; justify-content: space-between; align-items: center;
      width: 100%; margin-bottom: 18px;
    }
    .shop-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px; width: 100%;
    }
    @media (min-width: 460px) { .shop-grid { grid-template-columns: repeat(3, 1fr); } }

    .char-card {
      background: #131340; border: 2px solid #2a2a6a;
      border-radius: 12px; padding: 10px 8px 10px;
      display: flex; flex-direction: column; align-items: center; gap: 5px;
      position: relative;
    }
    .char-card.active-card { border-color: #22b422; }
    .char-card.majka-card  { border-color: #ffd700; box-shadow: 0 0 14px #ffd70055; }
    .char-card img {
      width: 68px; height: 68px; object-fit: cover;
      border-radius: 8px; background: #0f1432;
    }
    .cc-name    { color: #fff; font-weight: bold; font-size: .85rem; text-align: center; }
    .cc-bonuses { color: #8be; font-size: .62rem; text-align: center; line-height: 1.35; min-height: 26px; }
    .cc-btn {
      width: 100%; height: 34px;
      font-size: .78rem; font-weight: bold;
      border: none; border-radius: 7px; cursor: pointer;
      touch-action: manipulation; margin-top: 2px;
    }
    .cc-btn.active  { background: #22b422; color: #fff; }
    .cc-btn.select  { background: #1a6aff; color: #fff; }
    .cc-btn.buy     { background: #ffd700; color: #0f1432; }
    .cc-btn.locked  { background: #1e1e4a; color: #444; cursor: default; }

    /* â”€â”€ Char picker (lobby) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #charPicker { scrollbar-width: none; }
    #charPicker::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>

<!-- â”€â”€ Nick screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="nickScreen" class="screen">
  <div class="screen-inner">
    <div class="screen-title">ğŸ¦ Bobby Bird</div>
    <div class="screen-sub">Zaloguj siÄ™ lub stwÃ³rz konto (z PINem)</div>

    <input id="nickInput" class="big-input" type="text" maxlength="16"
      placeholder="TwÃ³j nick"
      autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />

    <input id="pinInput" class="big-input" type="password" maxlength="4"
      inputmode="numeric" placeholder="PIN (4 cyfry)"
      autocomplete="off" style="margin-bottom:8px" />

    <div id="loginError" style="color:#dc3232; font-size:14px; font-weight:bold; margin-bottom:12px; display:none;">
      BÅ‚Ä™dny PIN!
    </div>

    <button id="nickConfirm" class="btn btn-yellow">DALEJ â†’</button>
  </div>
</div>

<!-- â”€â”€ Lobby screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="lobbyScreen" class="screen" style="display:none">
  <div class="screen-inner">
    <div class="screen-title" style="font-size:1.55em;margin-bottom:2px">Bobby Bird</div>
    <div id="lobbyNick" style="color:#aaa;font-size:.85rem;margin-bottom:10px"></div>
    <div id="lobbyCoins" class="coins">ğŸµ 0 coinÃ³w</div>

    <div id="charPreview" class="char-preview">
      <img id="charPreviewImg" src="" alt="" />
      <div>
        <div id="charPreviewName" class="cp-name">Bobby</div>
        <div id="charPreviewBonus" class="cp-bonus">brak bonusÃ³w</div>
      </div>
    </div>

    <!-- Horizontal character picker -->
    <div id="charPicker"
      style="display:flex;overflow-x:auto;gap:8px;padding:4px 2px;
             width:100%;max-width:280px;margin-bottom:18px;
             -webkit-overflow-scrolling:touch">
    </div>

    <button id="lobbyPlay" class="btn btn-yellow">â–¶ GRAJ</button>
    <button id="lobbyShop" class="btn btn-blue">ğŸ›’ SKLEP</button>
    <button id="lobbySpikes" class="btn" style="display:none; background:#dc3232; color:#fff; margin-top:10px; border:2px solid #ff5555; box-shadow: 0 0 15px #dc323288;">ğŸ”¥ TRYB KOLCÃ“W (HARDCORE)</button>
  </div>
</div>

<!-- â”€â”€ Shop screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="shopScreen" class="screen" style="display:none">
  <div class="screen-inner" style="justify-content:flex-start;padding-top:20px">
    <div class="shop-header">
      <button id="shopBack" class="btn btn-dark btn-sm">â† WRÃ“Ä†</button>
      <div id="shopCoins" class="coins" style="margin:0">ğŸµ 0</div>
    </div>
    <div id="shopGrid" class="shop-grid"></div>
  </div>
</div>

<!-- â”€â”€ DOM HUD overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="hud" style="position:fixed;top:0;left:0;width:100%;pointer-events:none;z-index:10;display:none">
  <span id="hudCoins" style="position:absolute;top:10px;left:10px;color:#ffd700;font:bold 15px Arial">\uD83C\uDFB50</span>
  <span id="hudScore" style="position:absolute;top:6px;right:10px;color:#fff;font:bold 28px Arial;transition:transform 0.1s ease">0</span>
  <span id="hudHeart" style="position:absolute;top:30px;left:10px;font:15px Arial"></span>
</div>

<!-- â”€â”€ Game canvas (hidden until game starts) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<canvas id="gameCanvas" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) translateZ(0)"></canvas>

<script type="module">
// â”€â”€ Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, collection, doc,
         getDoc, setDoc, getDocs,
         query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey:            "AIzaSyCv02h10zIVw8DhrBhryiDnFIa_peZklKQ",
  authDomain:        "flappy-bobby.firebaseapp.com",
  projectId:         "flappy-bobby",
  storageBucket:     "flappy-bobby.firebasestorage.app",
  messagingSenderId: "79131027037",
  appId:             "1:79131027037:web:2224f6d16ef4f7e6a88fb4"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// â”€â”€ Leaderboard cache canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const lbCacheCanvas = document.createElement('canvas');
const lbCtx = lbCacheCanvas.getContext('2d');
let lbCacheReady = false;

// â”€â”€ Character definitions (ZBALANSOWANE CENY) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CHARACTERS = {
  bobby:    { name:'Bobby',     img:'bobby.png',    price:0,    col:'soundcloud.png',
              bonuses:[],                              desc:'brak bonusÃ³w' },
  bialek:   { name:'Bialek',    img:'bialek.png',   price:15,   col:'nina.png',
              bonuses:['gap+10'],                     desc:'przelot +10px' },
  deadman:  { name:'Deadman',   img:'deadman.png',  price:45,   col:'grammy.png',
              bonuses:['speed-5'],                    desc:'rury âˆ’5%' },
  krystian: { name:'Krystian',  img:'krystian.png', price:90,   col:'diormind.png',
              bonuses:['extralife'],                  desc:'+1 Å¼ycie' },
  johnny:   { name:'Johnny',    img:'johnny.png',   price:150,  col:'joint.png',
              bonuses:['gap+10','speed-5'],           desc:'przelot +10px, rury âˆ’5%' },
  kolin:    { name:'Kolin',     img:'kolin.png',    price:250,  col:'strzykawka.png',
              bonuses:['gap+20'],                     desc:'przelot +20px' },
  kutasa:   { name:'Kutasa',    img:'kutasa.png',   price:400,  col:'dziecko.png',
              bonuses:['speed-10','extralife'],       desc:'rury âˆ’10%, +1 Å¼ycie' },
  reczu:    { name:'Reczu',     img:'reczu.png',    price:550,  col:'kutas.png',
              bonuses:['gap+20','speed-10'],          desc:'przelot +20px, rury âˆ’10%' },
  szpachl:  { name:'Szpachl',   img:'szpachl.png',  price:750,  col:'scat.png',
              bonuses:['double'],                     desc:'Ã—2 punkty i monety' },
  tom:      { name:'Tom',       img:'tom.png',      price:950,  col:'wozek.png',
              bonuses:['extralife','double','speed-5'], desc:'+Å¼ycie, Ã—2 pkt, rury âˆ’5%' },
  majka:    { name:'Majka ğŸ‘‘',  img:'majka.png',    price:1200, col:'onlyfans.png',
              bonuses:['gap+30','speed-15','double','extralife'],
              desc:'WSZYSTKO: âˆ’15%, +30px, Ã—2, +Å¼ycie', special:true },
};
const CHAR_KEYS = Object.keys(CHARACTERS);

// â”€â”€ Firestore helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPlayerData(nick, pin) {
  try {
    const snap = await getDoc(doc(db, 'leaderboard', nick));
    if (snap.exists()) {
      const d = snap.data();
      if (d.pin && d.pin !== pin) return { error: 'invalid_pin' };
      if (!d.pin) await setDoc(doc(db, 'leaderboard', nick), { pin }, { merge: true });
      let skins = d.unlockedSkins;
      if (!Array.isArray(skins)) {
        if (typeof skins === 'string') { try { skins = JSON.parse(skins); } catch { skins = ['bobby']; } }
        if (!Array.isArray(skins)) skins = ['bobby'];
      }
      return { coins: d.coins ?? 0, unlockedSkins: skins, activeSkin: d.activeSkin ?? 'bobby', score: d.score ?? 0 };
    } else {
      await setDoc(doc(db, 'leaderboard', nick), {
        nick, score: 0, coins: 0, unlockedSkins: ['bobby'], activeSkin: 'bobby', pin, date: new Date()
      });
    }
  } catch(e) { console.warn('loadPlayerData:', e); }
  return { coins: 0, unlockedSkins: ['bobby'], activeSkin: 'bobby', score: 0 };
}

// â”€â”€ Ochrona limitÃ³w Firebase (Debouncing) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let saveTimeout = null;

async function saveProgress(roundScore = playerBestScore, immediate = false) {
  if (roundScore > playerBestScore) playerBestScore = roundScore;

  const executeSave = async () => {
    try {
      const ref = doc(db, 'leaderboard', playerNick);
      await setDoc(ref, {
        nick: playerNick, score: playerBestScore, date: new Date(),
        coins: playerCoins, unlockedSkins, activeSkin, pin: playerPin
      }, { merge: true });
    } catch(e) { console.warn('saveProgress:', e); }
  };

  if (immediate) {
    if (saveTimeout) { clearTimeout(saveTimeout); saveTimeout = null; }
    await executeSave();
  } else {
    if (!saveTimeout) {
      saveTimeout = setTimeout(() => {
        executeSave();
        saveTimeout = null;
      }, 5000);
    }
  }
}

async function getTopScores() {
  try {
    const snap = await getDocs(
      query(collection(db, 'leaderboard'), orderBy('score','desc'), limit(10))
    );
    return snap.docs.map(d => d.data());
  } catch(e) { console.warn('getTopScores:', e); return []; }
}

// â”€â”€ Canvas & DPR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas = document.getElementById('gameCanvas');
const ctx    = canvas.getContext('2d');
const GW = 400, GH = 600;
const isMobile = window.innerWidth < 600;
const dpr = Math.min(window.devicePixelRatio || 1, isMobile ? 1.5 : 2);
canvas.width  = Math.round(GW * dpr);
canvas.height = Math.round(GH * dpr);
canvas.style.imageRendering = 'auto';
ctx.scale(dpr, dpr);

let canvasRect = { left: 0, top: 0, width: GW, height: GH };
const _touchPos = { x: 0, y: 0 };

function resize() {
  const s = Math.min(window.innerWidth / GW, window.innerHeight / GH);
  canvas.style.width  = (GW * s) + 'px';
  canvas.style.height = (GH * s) + 'px';
  setTimeout(() => { canvasRect = canvas.getBoundingClientRect(); }, 0);
}
window.addEventListener('resize', resize);

// â”€â”€ Base constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GRAVITY = 0.45, JUMP_FORCE = -9.5, PIPE_SPEED = 2.55;
const PIPE_GAP = 175, PIPE_WIDTH = 72, PIPE_INTERVAL = 1750;
const BIRD_SIZE = 60, COL_W = 70;
const SPIKES_MODE_PRICE = 1000;

// â”€â”€ Pre-rendered background (stars) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STARS = Array.from({ length: 25 }, () => ({
  x: Math.random() * GW, y: Math.random() * GH * 0.75,
  r: Math.random() < 0.3 ? 1.5 : 1
}));
const bgCacheCanvas = document.createElement('canvas');
const bgCtx = bgCacheCanvas.getContext('2d');
const uiCacheCanvas = document.createElement('canvas');
let uiCacheReady = false;

function buildUICache() {
  uiCacheCanvas.width = GW; uiCacheCanvas.height = GH;
  const uctx = uiCacheCanvas.getContext('2d');
  uctx.textAlign = 'center';
  uctx.font = 'bold 52px Arial'; uctx.fillStyle = '#ffd700';
  uctx.fillText('Bobby Bird', GW/2, GH/4+10);
  const b = SHOP_BTN;
  uctx.fillStyle = '#1a6aff'; uctx.beginPath(); uctx.roundRect(b.x, b.y, b.w, b.h, 12); uctx.fill();
  uctx.font = 'bold 18px Arial'; uctx.fillStyle = '#fff';
  uctx.fillText('\uD83D\uDED2 SKLEP', b.x + b.w/2, b.y + b.h/2 + 7);
  const lb = LOBBY_BTN;
  uctx.fillStyle = '#dc3232'; uctx.beginPath(); uctx.roundRect(lb.x, lb.y, lb.w, lb.h, 12); uctx.fill();
  uctx.font = 'bold 16px Arial'; uctx.fillStyle = '#fff';
  uctx.fillText('ğŸ  LOBBY', lb.x + lb.w/2, lb.y + lb.h/2 + 7);
  uiCacheReady = true;
}
function renderBackgroundToCache() {
  bgCacheCanvas.width = GW; bgCacheCanvas.height = GH;
  bgCtx.fillStyle = '#0f1432';
  bgCtx.fillRect(0, 0, GW, GH);
  bgCtx.fillStyle = '#b4c8ff';
  for (const s of STARS) { bgCtx.beginPath(); bgCtx.arc(s.x, s.y, s.r, 0, Math.PI*2); bgCtx.fill(); }
}
renderBackgroundToCache();

// â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Background music â€” HTMLAudioElement (streaming)
const bgTracks = [
  new Audio('assets/sounds/music.mp3'),
  new Audio('assets/sounds/music2.mp3')
];
bgTracks.forEach(t => { t.volume = 0.3; });
let currentTrack = -1;

// Ustawiamy onended raz, nie przy kaÅ¼dym starcie
bgTracks[0].onended = () => { currentTrack = 1; bgTracks[1].currentTime = 0; bgTracks[1].play().catch(() => {}); };
bgTracks[1].onended = () => { currentTrack = 0; bgTracks[0].currentTime = 0; bgTracks[0].play().catch(() => {}); };

function startMusic() {
  bgTracks[currentTrack === -1 ? 0 : currentTrack].pause();
  currentTrack = (currentTrack + 1) % bgTracks.length;
  const track = bgTracks[currentTrack];
  track.currentTime = 0;
  track.play().catch(e => console.warn('music blocked:', e));
}

function stopMusic() {
  bgTracks.forEach(t => t.pause());
}

// â”€â”€ Strumienie Audio dla trybu Spikes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const spikesMusic = new Audio('assets/sounds/jeopardy.mp3');
spikesMusic.loop = true;
spikesMusic.volume = 0.25;

const spikesVoice = new Audio('assets/sounds/voice.mp3');
spikesVoice.loop = true;
spikesVoice.volume = 1.0;

function startSpikesAudio() {
  spikesMusic.currentTime = 0;
  spikesMusic.play().catch(e => console.warn('spikes music blocked:', e));
  spikesVoice.currentTime = 0;
  spikesVoice.play().catch(e => console.warn('spikes voice blocked:', e));
}

function stopSpikesAudio() {
  spikesMusic.pause();
  spikesVoice.pause();
}

function resumeMusic() {
  if (currentTrack < 0) return;
  bgTracks[currentTrack].play().catch(e => console.warn('music resume blocked:', e));
}

function resumeSpikesAudio() {
  spikesMusic.play().catch(e => console.warn('spikes music resume blocked:', e));
  spikesVoice.play().catch(e => console.warn('spikes voice resume blocked:', e));
}

// Sound effects â€” Web Audio API (low-latency, no pool needed)
const _AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new _AudioContext();
const audioBuffers = {};

async function loadAudioBuffer(key, url) {
  try {
    const res = await fetch(url);
    const arr = await res.arrayBuffer();
    audioBuffers[key] = await audioCtx.decodeAudioData(arr);
  } catch(e) { console.warn('Audio load error:', key, e); }
}

function playSound(key, vol = 1.0) {
  if (!audioBuffers[key]) return;
  const src = audioCtx.createBufferSource();
  src.buffer = audioBuffers[key];
  const gain = audioCtx.createGain();
  gain.gain.value = vol;
  src.connect(gain);
  gain.connect(audioCtx.destination);
  src.start(0);
}

const playKaching  = () => playSound('kaching',  0.5);
const playMumia    = () => playSound('mumia',    1.0);
const playDzwiek7  = () => playSound('dzwiek7',  1.0);
const playKrystian = () => playSound('krystian', 1.0);

loadAudioBuffer('kaching',  'assets/sounds/kaching.wav');
loadAudioBuffer('mumia',    'assets/sounds/mumia.mp3');
loadAudioBuffer('dzwiek7',  'assets/sounds/7.mp3');
loadAudioBuffer('krystian', 'assets/sounds/krystian.mp3');

function playSpecialSound(sc) {
  if (sc <= 0) return;
  if      (sc % 100 === 0) playKrystian();
  else if (sc % 10  === 0) playMumia();
  else if (sc % 10  === 7) playDzwiek7();
}

// â”€â”€ Image helpers (ProtokÃ³Å‚ Hybrydowy) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadImage(src) {
  return new Promise(resolve => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload  = () => resolve(img);
    img.onerror = () => { console.warn('Failed to load image:', src); resolve(null); };
    img.src = src;
  });
}

const spriteCache  = {};
const collectCache = {};

async function ensureSprite(key) {
  if (spriteCache[key] !== undefined) return;
  const ch = CHARACTERS[key];
  const fileName = ch.img ? ch.img : `${key}.png`;
  spriteCache[key] = await loadImage(`assets/characters/${fileName}`);
}

async function ensureCollectible(key) {
  if (collectCache[key] !== undefined) return;
  const ch = CHARACTERS[key];
  const fileName = ch.col ? ch.col : `${key}_col.png`;
  const img = await loadImage(`assets/collectibles/${fileName}`);
  if (img) {
    const h = Math.max(1, Math.round(img.naturalHeight * COL_W / img.naturalWidth));
    collectCache[key] = { img, h };
  } else {
    collectCache[key] = null;
  }
}

// Active skin assets (set in applyActiveSkin)
let playerImg       = null;
let collectImg      = null;
let collectH        = COL_W;

async function applyActiveSkin(key) {
  await ensureSprite(key);
  await ensureCollectible(key);
  playerImg   = spriteCache[key] || null;
  const c = collectCache[key];
  collectImg  = c ? c.img : null;
  collectH    = c ? c.h   : COL_W;
}

// â”€â”€ Player state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let playerNick    = '';
let playerCoins   = 0;
let unlockedSkins = ['bobby'];
let activeSkin      = 'bobby';
let playerBestScore = 0; // PamiÄ™Ä‡ RAM dla najlepszego wyniku
let playerPin       = '';

// â”€â”€ Session params (computed from active skin) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let S_GAP = PIPE_GAP, S_SPEED = PIPE_SPEED, S_DOUBLE = false, S_EXTRA = false;
let S_INTERVAL = PIPE_INTERVAL;

function computeSessionParams() {
  const b = CHARACTERS[activeSkin].bonuses;
  S_GAP    = PIPE_GAP + (b.includes('gap+30') ? 30 : b.includes('gap+20') ? 20 : b.includes('gap+10') ? 10 : 0);
  S_SPEED  = PIPE_SPEED * (b.includes('speed-15') ? 0.85 : b.includes('speed-10') ? 0.90 : b.includes('speed-5') ? 0.95 : 1);
  S_DOUBLE = b.includes('double');
  S_EXTRA  = b.includes('extralife');
  S_INTERVAL = PIPE_INTERVAL * (PIPE_SPEED / S_SPEED);
}

// â”€â”€ Extra life â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let extraLifeAvail = false;
let flashUntil     = 0;

// â”€â”€ Globalne zmienne stanu (BrakujÄ…ce deklaracje) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let leaderboard          = [];
let leaderboardLoading   = false;
let cachedLeaderboard    = [];
let lastLeaderboardFetch = 0;
const _cr = { x: 0, y: 0, w: 0, h: 0 };
const _pr = { x: 0, y: 0, w: 0, h: 0 };

// â”€â”€ Screen management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nickScreen  = document.getElementById('nickScreen');
const lobbyScreen = document.getElementById('lobbyScreen');
const shopScreen  = document.getElementById('shopScreen');

// â”€â”€ DOM HUD elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const hudEl      = document.getElementById('hud');
const hudCoinsEl = document.getElementById('hudCoins');
const hudScoreEl = document.getElementById('hudScore');
const hudHeartEl = document.getElementById('hudHeart');
let _hud_coins = -1, _hud_score = -1, _hud_extra = null;

function updateHUD(currentScore) {
  if (_hud_coins !== playerCoins) {
    _hud_coins = playerCoins;
    hudCoinsEl.textContent = '\uD83C\uDFB5' + playerCoins;
  }
  if (_hud_score !== currentScore) {
    _hud_score = currentScore;
    hudScoreEl.textContent = currentScore;
    hudScoreEl.style.transform = 'scale(1.3)';
    setTimeout(() => { hudScoreEl.style.transform = 'scale(1)'; }, 100);
  }
  const heartState = S_EXTRA ? (extraLifeAvail ? '\u2665' : '\u2661') : '';
  if (_hud_extra !== heartState) {
    _hud_extra = heartState;
    hudHeartEl.textContent = heartState;
    hudHeartEl.style.color = (S_EXTRA && extraLifeAvail) ? '#dc3232' : '#444';
  }
}

let isGameCanvasVisible = false;

function hideAll() {
  nickScreen.style.display = lobbyScreen.style.display =
  shopScreen.style.display = canvas.style.display =
  hudEl.style.display = 'none';
  isGameCanvasVisible = false;
}
function showLobby() {
  hideAll();
  lobbyScreen.style.display = 'flex';
  updateLobbyUI();
}
function showShop() {
  hideAll();
  shopScreen.style.display = 'flex';
  renderShop();
}
function showGame() {
  hideAll();
  canvas.style.display = hudEl.style.display = 'block';
  isGameCanvasVisible = true;
  resize();
  startGameLoop();
}

// â”€â”€ Nick screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nickInput   = document.getElementById('nickInput');
const pinInput    = document.getElementById('pinInput');
const loginError  = document.getElementById('loginError');
const nickConfirm = document.getElementById('nickConfirm');
let nickDone = false;

async function onNickConfirm() {
  if (nickDone) return;
  const val = nickInput.value.trim();
  const pin = pinInput.value.trim();

  if (!val) { nickInput.classList.add('error'); return; }
  if (!pin || pin.length < 4) { pinInput.classList.add('error'); return; }

  nickInput.classList.remove('error');
  pinInput.classList.remove('error');
  loginError.style.display = 'none';

  const data = await loadPlayerData(val, pin);
  if (data.error === 'invalid_pin') {
    loginError.style.display = 'block';
    return;
  }

  nickDone = true;
  playerNick = val.slice(0, 16);
  playerPin  = pin;

  playerCoins     = data.coins;
  unlockedSkins   = data.unlockedSkins;
  playerBestScore = data.score;
  if (!unlockedSkins.includes('bobby')) unlockedSkins.push('bobby');
  activeSkin = unlockedSkins.includes(data.activeSkin) ? data.activeSkin : 'bobby';

  await applyActiveSkin(activeSkin);
  showLobby();
}

nickConfirm.addEventListener('click',    onNickConfirm);
nickConfirm.addEventListener('touchend', e => { e.preventDefault(); onNickConfirm(); });
nickInput.addEventListener('keydown', e => { if (e.key === 'Enter') onNickConfirm(); e.stopPropagation(); });
nickInput.focus();

// â”€â”€ Lobby UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateLobbyUI() {
  document.getElementById('lobbyNick').textContent        = playerNick;
  document.getElementById('lobbyCoins').textContent       = '\uD83C\uDFB5 ' + playerCoins + ' coin\xF3w';
  document.getElementById('charPreviewName').textContent  = CHARACTERS[activeSkin].name;
  document.getElementById('charPreviewBonus').textContent = CHARACTERS[activeSkin].desc;
  document.getElementById('charPreviewImg').src           = `assets/characters/${CHARACTERS[activeSkin].img}`;
  renderCharPicker();

  const spikesBtn = document.getElementById('lobbySpikes');
  const unlockedChars = unlockedSkins.filter(k => CHAR_KEYS.includes(k)).length;
  const hasSpikes = unlockedSkins.includes('spikes');

  spikesBtn.style.display = 'flex';

  if (hasSpikes) {
    spikesBtn.style.background  = '#dc3232';
    spikesBtn.style.color       = '#fff';
    spikesBtn.style.borderColor = '#ff5555';
    spikesBtn.style.boxShadow   = '0 0 15px #dc323288';
    spikesBtn.textContent       = 'ğŸ”¥ GRAJ W TRYB KOLCÃ“W';
    spikesBtn.disabled          = false;
  } else if (unlockedChars >= 5) {
    spikesBtn.style.background  = '#ffd700';
    spikesBtn.style.color       = '#0f1432';
    spikesBtn.style.borderColor = '#cca100';
    spikesBtn.style.boxShadow   = 'none';
    spikesBtn.textContent       = `ğŸ”“ KUP TRYB KOLCÃ“W (\uD83C\uDFB5 ${SPIKES_MODE_PRICE})`;
    spikesBtn.disabled          = false;
  } else {
    spikesBtn.style.background  = '#1e1e4a';
    spikesBtn.style.color       = '#666';
    spikesBtn.style.borderColor = '#333';
    spikesBtn.style.boxShadow   = 'none';
    spikesBtn.textContent       = `ğŸ”’ TRYB KOLCÃ“W (${unlockedChars}/5 postaci)`;
    spikesBtn.disabled          = true;
  }
}

// â”€â”€ Zoptymalizowany Char Picker (DOM Hydration) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let charPickerInitialized = false;
const charPickerUI = {};

function renderCharPicker() {
  const bar = document.getElementById('charPicker');
  if (!bar) return;

  if (!charPickerInitialized) {
    bar.innerHTML = '';
    CHAR_KEYS.forEach(key => {
      const ch = CHARACTERS[key];
      const wrap = document.createElement('div');
      wrap.style.cssText = 'flex-shrink:0;position:relative;border-radius:8px;touch-action:manipulation;';

      const img = document.createElement('img');
      img.src = `assets/characters/${ch.img || key + '.png'}`;
      img.alt = ch.name;
      img.style.cssText = 'width:50px;height:50px;object-fit:cover;border-radius:6px;display:block;background:#0f1432';

      const lock = document.createElement('div');
      lock.style.cssText = 'position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:16px;pointer-events:none;border-radius:6px;background:rgba(0,0,0,.35)';
      lock.textContent = '\uD83D\uDD12';

      wrap.append(img, lock);

      let pGuard = false;
      async function pickChar(e) {
        if (e) e.preventDefault();
        if (pGuard || activeSkin === key || !unlockedSkins.includes(key)) return;
        pGuard = true;
        activeSkin = key;
        await applyActiveSkin(key);
        updateLobbyUI();
        saveProgress(playerBestScore, true).finally(() => { pGuard = false; });
      }
      wrap.addEventListener('pointerdown', e => {
        if (e.pointerType === 'mouse' && e.button !== 0) return;
        pickChar(e);
      });

      bar.appendChild(wrap);
      charPickerUI[key] = { wrap, lock };
    });
    charPickerInitialized = true;
  }

  CHAR_KEYS.forEach(key => {
    const owned  = unlockedSkins.includes(key);
    const active = activeSkin === key;
    const ui = charPickerUI[key];
    ui.wrap.style.border  = `2px solid ${active ? '#ffd700' : 'transparent'}`;
    ui.wrap.style.opacity = owned ? '1' : '0.4';
    ui.wrap.style.cursor  = owned ? 'pointer' : 'default';
    ui.lock.style.display = owned ? 'none' : 'flex';
  });
}

let lobbyPlayGuard = false;
async function onLobbyPlay() {
  if (lobbyPlayGuard) return;
  lobbyPlayGuard = true;
  computeSessionParams();
  await applyActiveSkin(activeSkin);
  SceneManager.changeScene(FlappyMode);
  showGame();
  setTimeout(() => { lobbyPlayGuard = false; }, 500);
}

const lobbyPlay = document.getElementById('lobbyPlay');
const lobbyShop = document.getElementById('lobbyShop');
lobbyPlay.addEventListener('click',    onLobbyPlay);
lobbyPlay.addEventListener('touchend', e => { e.preventDefault(); onLobbyPlay(); });
lobbyShop.addEventListener('click',    () => showShop());
lobbyShop.addEventListener('touchend', e => { e.preventDefault(); showShop(); });

const lobbySpikes = document.getElementById('lobbySpikes');
async function onLobbySpikes() {
  if (lobbyPlayGuard) return;
  const hasSpikes = unlockedSkins.includes('spikes');
  const unlockedChars = unlockedSkins.filter(k => CHAR_KEYS.includes(k)).length;

  if (!hasSpikes) {
    if (unlockedChars < 5) return;
    if (playerCoins < SPIKES_MODE_PRICE) {
      const btn = document.getElementById('lobbySpikes');
      btn.style.background = '#dc3232';
      setTimeout(() => updateLobbyUI(), 300);
      return;
    }
    playerCoins -= SPIKES_MODE_PRICE;
    unlockedSkins.push('spikes');
    await saveProgress(playerBestScore, true);
    updateLobbyUI();
    return;
  }

  lobbyPlayGuard = true;
  computeSessionParams();
  await applyActiveSkin(activeSkin);
  SceneManager.changeScene(SpikesMode);
  showGame();
  setTimeout(() => { lobbyPlayGuard = false; }, 500);
}
lobbySpikes.addEventListener('click', onLobbySpikes);
lobbySpikes.addEventListener('touchend', e => { e.preventDefault(); onLobbySpikes(); });

// â”€â”€ Shop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onShopBack() {
  if (shopFromWaiting) {
    shopFromWaiting = false;
    computeSessionParams(); SceneManager.changeScene(FlappyMode);
    hideAll();
    canvas.style.display = hudEl.style.display = 'block';
    isGameCanvasVisible = true;
    resize();
  } else { showLobby(); }
}
document.getElementById('shopBack').addEventListener('click',    () => onShopBack());
document.getElementById('shopBack').addEventListener('touchend', e => { e.preventDefault(); onShopBack(); });

// â”€â”€ Ostateczna Architektura Sklepu (DOM Hydration & Optimistic UI) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let shopInitialized = false;
const shopUI = {};
let shopActionGuard = false;

function renderShop() {
  document.getElementById('shopCoins').textContent = 'ğŸµ ' + playerCoins;
  const grid = document.getElementById('shopGrid');
  if (!grid) return;

  if (!shopInitialized) {
    grid.innerHTML = '';
    CHAR_KEYS.forEach(key => {
      const ch = CHARACTERS[key];
      const card = document.createElement('div');
      const img = document.createElement('img');
      img.src = `assets/characters/${ch.img}`;
      img.alt = ch.name;
      img.onerror = () => { img.style.opacity = '.3'; };
      const name = document.createElement('div');
      name.className = 'cc-name'; name.textContent = ch.name;
      const bonuses = document.createElement('div');
      bonuses.className = 'cc-bonuses'; bonuses.textContent = ch.desc;
      const btn = document.createElement('button');
      btn.addEventListener('pointerdown', (e) => {
        if (e.pointerType === 'mouse' && e.button !== 0) return;
        e.preventDefault();
        handleShopAction(key);
      });
      card.append(img, name, bonuses, btn);
      grid.appendChild(card);
      shopUI[key] = { card, btn };
    });
    shopInitialized = true;
  }

  CHAR_KEYS.forEach(key => {
    const ch       = CHARACTERS[key];
    const owned    = unlockedSkins.includes(key);
    const isActive = activeSkin === key;
    const canBuy   = !owned && playerCoins >= ch.price;
    const ui       = shopUI[key];
    ui.card.className = 'char-card' + (isActive ? ' active-card' : '') + (ch.special ? ' majka-card' : '');
    ui.btn.className  = 'cc-btn ' + (isActive ? 'active' : owned ? 'select' : canBuy ? 'buy' : 'locked');
    ui.btn.textContent = isActive ? 'âœ“ AKTYWNA'
                       : owned    ? 'WYBIERZ'
                       : canBuy   ? `KUP \uD83C\uDFB5${ch.price}`
                       :            `\uD83D\uDD12 ${ch.price}\uD83C\uDFB5`;
    ui.btn.disabled = isActive || (!owned && !canBuy);
  });
}

function handleShopAction(key) {
  if (shopActionGuard) return;
  const ch = CHARACTERS[key];
  const owned = unlockedSkins.includes(key);
  if (owned) {
    if (activeSkin === key) return;
    activeSkin = key;
  } else {
    if (playerCoins < ch.price) return;
    playerCoins -= ch.price;
    unlockedSkins.push(key);
    activeSkin = key;
  }
  shopActionGuard = true;
  applyActiveSkin(key).then(() => {
    renderShop();
    updateLobbyUI();
    saveProgress(playerBestScore, true).finally(() => { shopActionGuard = false; });
  });
}

// â”€â”€ Scene Manager (Maszyna StanÃ³w) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SceneManager = {
  activeScene: null,

  changeScene(newScene) {
    stopMusic();
    stopSpikesAudio();
    if (this.activeScene && this.activeScene.cleanup) this.activeScene.cleanup();
    this.activeScene = newScene;
    if (this.activeScene.init) this.activeScene.init();
  },

  update(dt) { if (this.activeScene && this.activeScene.update) this.activeScene.update(dt); },
  draw()     { if (this.activeScene && this.activeScene.draw)   this.activeScene.draw();   },
  onAction(px, py) { if (this.activeScene && this.activeScene.onAction) this.activeScene.onAction(px, py); }
};

// â”€â”€ KartridÅ¼ 1: Flappy Mode (Klasyczny Bobby Bird) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FlappyMode = {
  state: 'waiting',
  score: 0,
  pipeTimer: 0,
  gameOverAt: 0,
  pipePool: Array.from({ length: 6 }, () => ({
    active: false, x: 0, topH: 0, botY: 0, passed: false, collected: false
  })),

  // Hermetyzacja ptaka tylko dla tego trybu
  bird: {
    x: 80, y: 300, vy: 0,
    _r: { x: 0, y: 0, w: BIRD_SIZE - 30, h: BIRD_SIZE - 30 },

    jump()     { this.vy = JUMP_FORCE; },
    update(dt) {
      const f = dt / 16.667;
      const deltaY = this.vy * f + 0.5 * GRAVITY * f * f;
      this.vy += GRAVITY * f;
      this.y  += deltaY;
    },

    rect() { this._r.x = this.x + 15; this._r.y = this.y + 15; return this._r; }
  },

  // Inicjalizacja sesji (ZastÄ™puje initNewSession i resetGame)
  init() {
    this.resetState();
    updateHUD(this.score); // Inicjalizacja HUD
  },

  resetState() {
    this.bird.x = 80; this.bird.y = GH/2; this.bird.vy = 0;
    this.pipePool.forEach(p => p.active = false);
    this.pipeTimer = 0;
    this.score = 0;
    leaderboard = [];
    leaderboardLoading = false;
    lbCacheReady = false;
    extraLifeAvail = S_EXTRA;
    flashUntil = 0;
    this.state = 'waiting';
  },

  startGame() {
    this.state = 'playing';
    this.bird.jump();
    startMusic();
  },

  async die() {
    if (extraLifeAvail) {
      extraLifeAvail = false;
      flashUntil = performance.now() + 1500;
      this.bird.vy = JUMP_FORCE;
      return;
    }
    stopMusic();
    this.gameOverAt = performance.now();
    this.state = 'gameover';
    leaderboardLoading = true;
    leaderboard = [];

    saveProgress(this.score);

    if (this.score > playerBestScore) {
      playerBestScore = this.score;
      const existingMe = cachedLeaderboard.find(e => e.nick === playerNick);
      if (existingMe) existingMe.score = this.score;
      else cachedLeaderboard.push({ nick: playerNick, score: this.score });
      cachedLeaderboard.sort((a, b) => b.score - a.score);
      cachedLeaderboard = cachedLeaderboard.slice(0, 10);
    }

    const now = performance.now();
    if (now - lastLeaderboardFetch > 60000 || cachedLeaderboard.length === 0) {
      cachedLeaderboard = await getTopScores();
      lastLeaderboardFetch = now;
    }

    leaderboard = cachedLeaderboard;
    leaderboardLoading = false;
    this.renderLeaderboardCache();
  },

  renderLeaderboardCache() {
    lbCacheCanvas.width = GW; lbCacheCanvas.height = 300;
    lbCtx.clearRect(0, 0, GW, 300);
    if (!leaderboard.length) {
      txt(lbCtx, 'Brak wynikÃ³w', GW/2, 22, '13px Arial', '#888', 'center');
    } else {
      leaderboard.forEach((e, i) => {
        const ry = 20 + i * 22;
        const color = e.nick === playerNick ? '#ffd700' : (i < 3 ? '#fff' : '#909090');
        txt(lbCtx, `${i+1}. ${e.nick}`, 22, ry, '13px Arial', color, 'left');
        txt(lbCtx, String(e.score), GW-22, ry, '13px Arial', color, 'right');
      });
    }
    lbCacheReady = true;
  },

  spawnPipe() {
    const p = this.pipePool.find(pipe => !pipe.active);
    if (!p) return;
    const gc = GH/4 + Math.random() * (GH/2);
    p.active = true; p.x = GW;
    p.topH = gc - S_GAP/2; p.botY = gc + S_GAP/2;
    p.passed = false; p.collected = false;
  },

  update(dt) {
    if (this.state === 'gameover' || this.state !== 'playing') return;

    this.bird.update(dt);
    this.pipeTimer += dt;
    if (this.pipeTimer >= S_INTERVAL) { this.spawnPipe(); this.pipeTimer = 0; }

    const f = dt / 16.667;
    const br = this.bird.rect();

    const isInvincible = performance.now() < flashUntil;

    for (let i = 0; i < this.pipePool.length; i++) {
      const p = this.pipePool[i];
      if (!p.active) continue;

      p.x -= S_SPEED * f;
      if (!p.passed && p.x + PIPE_WIDTH < this.bird.x) p.passed = true;
      if (p.x + PIPE_WIDTH <= 0) { p.active = false; continue; }

      if (!p.collected) {
        _cr.x = p.x + PIPE_WIDTH/2 - COL_W/2;
        _cr.y = (p.topH + p.botY)/2 - collectH/2;
        _cr.w = COL_W;
        _cr.h = collectH;
        if (overlaps(br, _cr)) {
          p.collected = true;
          const pts = S_DOUBLE ? 2 : 1;
          this.score += pts; playerCoins += pts;
          playKaching(); playSpecialSound(this.score);
        }
      }

      if (!isInvincible) {
        const CAP_H = 28;
        const CAP_EX = 10;

        // GÃ³rna rura â€” ciaÅ‚o
        _pr.x = p.x; _pr.w = PIPE_WIDTH; _pr.y = 0; _pr.h = p.topH - CAP_H;
        if (overlaps(br, _pr)) { this.die(); return; }

        // GÃ³rna rura â€” koÅ‚nierz
        _pr.x = p.x - CAP_EX; _pr.w = PIPE_WIDTH + CAP_EX * 2; _pr.y = p.topH - CAP_H; _pr.h = CAP_H;
        if (overlaps(br, _pr)) { this.die(); return; }

        // Dolna rura â€” koÅ‚nierz
        _pr.x = p.x - CAP_EX; _pr.w = PIPE_WIDTH + CAP_EX * 2; _pr.y = p.botY; _pr.h = CAP_H;
        if (overlaps(br, _pr)) { this.die(); return; }

        // Dolna rura â€” ciaÅ‚o
        _pr.x = p.x; _pr.w = PIPE_WIDTH; _pr.y = p.botY + CAP_H; _pr.h = GH - (p.botY + CAP_H);
        if (overlaps(br, _pr)) { this.die(); return; }
      }
    }

    if (this.bird.y > GH || this.bird.y < -BIRD_SIZE) { this.die(); return; }
  },

  draw() {
    if (this.state === 'waiting') {
      ctx.globalAlpha = 0.65;
      ctx.drawImage(bgCacheCanvas, 0, 0);
      ctx.globalAlpha = 1.0;
    } else {
      ctx.drawImage(bgCacheCanvas, 0, 0);
    }

    ctx.fillStyle = '#22b422';
    for (const p of this.pipePool) {
      if (!p.active) continue;
      if (p.topH > 0) ctx.fillRect(p.x, 0, PIPE_WIDTH, p.topH);
      if (p.botY < GH) ctx.fillRect(p.x, p.botY, PIPE_WIDTH, GH - p.botY);
    }

    ctx.fillStyle = '#127812';
    const _cap = 28, _bw = PIPE_WIDTH + 20;
    for (const p of this.pipePool) {
      if (!p.active) continue;
      const bx = p.x - 10;
      if (p.topH > 0) ctx.fillRect(bx, p.topH - _cap, _bw, _cap);
      if (p.botY < GH) ctx.fillRect(bx, p.botY, _bw, _cap);
    }

    if (collectImg) {
      for (const p of this.pipePool) {
        if (p.active && !p.collected)
          ctx.drawImage(collectImg, p.x+PIPE_WIDTH/2-COL_W/2, (p.topH+p.botY)/2-collectH/2, COL_W, collectH);
      }
    }

    if (this.state !== 'waiting') {
      const now = performance.now();
      const isInvincible = now < flashUntil;
      if (!isInvincible || ((now / 150) | 0) % 2 === 0) {
        drawBirdAt(this.bird.x, this.bird.y, Math.max(-35, Math.min(50, -this.bird.vy*3)));
      }
    }

    updateHUD(this.score);

    if (this.state === 'waiting') this.drawWaiting();
    else if (this.state === 'gameover') this.drawGameOver();
  },

  drawWaiting() {
    if (!uiCacheReady) buildUICache();
    ctx.drawImage(uiCacheCanvas, 0, 0);
    const hy = GH/2 - BIRD_SIZE/2 + Math.sin(performance.now()/333)*12;
    drawBirdAt(GW/2 - BIRD_SIZE/2, hy, 0);
    if (((performance.now() / 600) | 0) % 2 === 0) {
      txt(ctx, 'Tap lub SPACJA aby zaczÄ…Ä‡', GW/2, GH*2/3+10, 'bold 20px Arial', '#fff');
    }
  },

  drawGameOver() {
    overlay(0.62);
    txt(ctx, 'GAME OVER', GW/2, 72, 'bold 44px Arial', '#dc3232');
    txt(ctx, 'Score: '+this.score, GW/2, 108, 'bold 26px Arial', '#ffd700');
    ctx.strokeStyle='#444'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(20,122); ctx.lineTo(GW-20,122); ctx.stroke();

    txt(ctx, '\uD83C\uDFC6 TOP 10', GW/2, 138, 'bold 15px Arial', '#ffd700');
    if (leaderboardLoading) txt(ctx, 'Åadowanie...', GW/2, 138+22, '13px Arial', '#888');
    else if (lbCacheReady) ctx.drawImage(lbCacheCanvas, 0, 138);

    ctx.beginPath(); ctx.moveTo(20,380); ctx.lineTo(GW-20,380); ctx.stroke();
    const lb = LOBBY_BTN;
    ctx.fillStyle = '#dc3232'; ctx.beginPath(); ctx.roundRect(lb.x, lb.y, lb.w, lb.h, 12); ctx.fill();
    txt(ctx, 'ğŸ  LOBBY', lb.x + lb.w/2, lb.y + lb.h/2 + 7, 'bold 16px Arial', '#fff');

    const canRestart = (performance.now() - this.gameOverAt) > 1000;
    txt(ctx, canRestart ? 'Tapnij, aby zagraÄ‡ ponownie' : 'Czekaj...', GW/2, 402, '15px Arial', canRestart ? '#fff' : '#555');
  },

  onAction(px, py) {
    if (px !== undefined && py !== undefined) {
      if (this.state === 'waiting' && hitShopBtn(px, py)) {
        showShopFromWaiting(); return;
      }
      if ((this.state === 'waiting' || this.state === 'gameover') && hitLobbyBtn(px, py)) {
        stopMusic();
        showLobby();
        return;
      }
    }
    if (this.state === 'waiting')  { this.startGame(); return; }
    if (this.state === 'playing')  { this.bird.jump(); return; }
    if (this.state === 'gameover') {
      if (performance.now() - this.gameOverAt > 1000) this.resetState();
      return;
    }
  }
};

// â”€â”€ Offscreen Canvas dla KolcÃ³w (Optymalizacja GPU) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const spikeLeftCanvas = document.createElement('canvas');
spikeLeftCanvas.width = 24; spikeLeftCanvas.height = 32;
const slCtx = spikeLeftCanvas.getContext('2d');
slCtx.fillStyle = '#888'; slCtx.beginPath();
slCtx.moveTo(0, 0); slCtx.lineTo(24, 16); slCtx.lineTo(0, 32); slCtx.fill();

const spikeRightCanvas = document.createElement('canvas');
spikeRightCanvas.width = 24; spikeRightCanvas.height = 32;
const srCtx = spikeRightCanvas.getContext('2d');
srCtx.fillStyle = '#888'; srCtx.beginPath();
srCtx.moveTo(24, 0); srCtx.lineTo(0, 16); srCtx.lineTo(24, 32); srCtx.fill();

// â”€â”€ KartridÅ¼ 2: Spikes Mode (End-Game) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SpikesMode = {
  state: 'waiting',
  score: 0,
  gameOverAt: 0,
  spikesLeft: [],
  spikesRight: [],
  maxSpikes: 3,
  _secArray: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],

  bird: {
    x: GW/2 - BIRD_SIZE/2, y: GH/2,
    vx: 4.5, vy: 0,
    _r: { x: 0, y: 0, w: BIRD_SIZE - 12, h: BIRD_SIZE - 12 },

    jump() { this.vy = JUMP_FORCE; },
    update(dt) {
      const f = dt / 16.667;
      const deltaY = this.vy * f + 0.5 * GRAVITY * f * f;
      this.vy += GRAVITY * f;
      this.y  += deltaY;
      this.x  += this.vx * f;
    },

    rect() { this._r.x = this.x + 6; this._r.y = this.y + 6; return this._r; }
  },

  init() {
    this.resetState();
    updateHUD(this.score);
  },

  resetState() {
    this.bird.x = GW/2 - BIRD_SIZE/2; this.bird.y = GH/2;
    this.bird.vx = Math.random() > 0.5 ? 4.5 : -4.5;
    this.bird.vy = 0;
    this.score = 0;
    this.maxSpikes = 3;
    this.spikesLeft = [];
    this.spikesRight = [];
    leaderboard = []; leaderboardLoading = false; lbCacheReady = false;
    extraLifeAvail = S_EXTRA; flashUntil = 0;
    this.state = 'waiting';
  },

  startGame() {
    this.state = 'playing';
    this.bird.jump();
    startSpikesAudio();
  },

  async die() {
    if (extraLifeAvail) {
      extraLifeAvail = false;
      flashUntil = performance.now() + 1500;
      this.bird.vy = JUMP_FORCE;
      return;
    }
    stopSpikesAudio();
    this.gameOverAt = performance.now();
    this.state = 'gameover';
    if (this.score > playerBestScore) playerBestScore = this.score;
    saveProgress(this.score);
  },

  generateSpikes(side) {
    const arr = side === 'left' ? this.spikesLeft : this.spikesRight;

    const padding = 100;
    const usableHeight = GH - (padding * 2);
    const sections = 12;
    const sectionHeight = usableHeight / sections;

    // In-place Fisher-Yates Shuffle (zero alokacji pamiÄ™ci)
    for (let i = sections - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [this._secArray[i], this._secArray[j]] = [this._secArray[j], this._secArray[i]];
    }

    for (let i = 0; i < this.maxSpikes; i++) {
      const sec = this._secArray[i];
      const spikeY = padding + (sec * sectionHeight) + (sectionHeight/2);
      if (!arr[i]) {
        arr[i] = { y: spikeY, active: true };
      } else {
        arr[i].y = spikeY;
        arr[i].active = true;
      }
    }
    arr.length = this.maxSpikes;
  },

  update(dt) {
    if (this.state === 'gameover' || this.state !== 'playing') return;
    this.bird.update(dt);
    const br = this.bird.rect();
    const isInvincible = performance.now() < flashUntil;

    if (this.bird.x <= 0) {
      this.bird.x = 0;
      this.bird.vx *= -1;
      this.bird.vy = JUMP_FORCE * 0.75;
      this.onWallHit('right');
    } else if (this.bird.x + BIRD_SIZE >= GW) {
      this.bird.x = GW - BIRD_SIZE;
      this.bird.vx *= -1;
      this.bird.vy = JUMP_FORCE * 0.75;
      this.onWallHit('left');
    }

    if (!isInvincible) {
      if (this.bird.x < 30) {
        for (const sp of this.spikesLeft) {
          if (overlapsSpike(br, sp.y, 'left')) { this.die(); return; }
        }
      } else if (this.bird.x > GW - BIRD_SIZE - 30) {
        for (const sp of this.spikesRight) {
          if (overlapsSpike(br, sp.y, 'right')) { this.die(); return; }
        }
      }
    }

    if (this.bird.y > GH || this.bird.y < -BIRD_SIZE) { this.die(); return; }
  },

  onWallHit(nextWall) {
    const pts = S_DOUBLE ? 2 : 1;
    this.score += pts;
    playerCoins += pts;
    if (this.score % 5 === 0 && this.maxSpikes < 10) this.maxSpikes++;

    const maxVx = 8.5;
    if (Math.abs(this.bird.vx) < maxVx) {
      this.bird.vx += (this.bird.vx > 0 ? 0.15 : -0.15);
    }

    this.generateSpikes(nextWall);
    if (nextWall === 'right') this.spikesLeft.length = 0;
    else this.spikesRight.length = 0;
  },

  draw() {
    if (this.state === 'waiting') {
      ctx.globalAlpha = 0.65; ctx.drawImage(bgCacheCanvas, 0, 0); ctx.globalAlpha = 1.0;
    } else { ctx.drawImage(bgCacheCanvas, 0, 0); }

    this.spikesLeft.forEach(sp => {
      ctx.drawImage(spikeLeftCanvas, 0, sp.y - 16);
    });

    this.spikesRight.forEach(sp => {
      ctx.drawImage(spikeRightCanvas, GW - 24, sp.y - 16);
    });

    if (this.state !== 'waiting') {
      const now = performance.now();
      const isInvincible = now < flashUntil;
      if (playerImg && (!isInvincible || ((now / 150) | 0) % 2 === 0)) {
        ctx.save();
        ctx.translate(this.bird.x + BIRD_SIZE/2, this.bird.y + BIRD_SIZE/2);
        if (this.bird.vx < 0) ctx.scale(-1, 1);
        ctx.rotate(Math.max(-20, Math.min(20, this.bird.vy * 2)) * Math.PI / 180);
        ctx.drawImage(playerImg, -BIRD_SIZE/2, -BIRD_SIZE/2, BIRD_SIZE, BIRD_SIZE);
        ctx.restore();
      }
    }

    updateHUD(this.score);
    if (this.state === 'waiting') this.drawWaiting();
    else if (this.state === 'gameover') this.drawGameOver();
  },

  drawWaiting() {
    txt(ctx, 'SPIKES MODE', GW/2, GH/4+10, 'bold 48px Arial', '#dc3232');
    const hy = GH/2 - BIRD_SIZE/2 + Math.sin(performance.now()/333)*12;
    drawBirdAt(GW/2 - BIRD_SIZE/2, hy, 0);
    if (((performance.now() / 600) | 0) % 2 === 0)
      txt(ctx, 'Tapnij aby zaczÄ…Ä‡', GW/2, GH*2/3+10, 'bold 20px Arial', '#fff');
    const b = LOBBY_BTN;
    ctx.fillStyle = '#dc3232'; ctx.beginPath(); ctx.roundRect(b.x, b.y, b.w, b.h, 12); ctx.fill();
    txt(ctx, 'ğŸ  LOBBY', b.x + b.w/2, b.y + b.h/2 + 7, 'bold 16px Arial', '#fff');
  },

  drawGameOver() {
    overlay(0.7);
    txt(ctx, 'ZGINÄ„ÅEÅš', GW/2, GH/3, 'bold 44px Arial', '#dc3232');
    txt(ctx, 'Wynik: '+this.score, GW/2, GH/2, 'bold 30px Arial', '#ffd700');
    const b = LOBBY_BTN;
    ctx.fillStyle = '#dc3232'; ctx.beginPath(); ctx.roundRect(b.x, b.y, b.w, b.h, 12); ctx.fill();
    txt(ctx, 'ğŸ  LOBBY', b.x + b.w/2, b.y + b.h/2 + 7, 'bold 16px Arial', '#fff');
    const canRestart = (performance.now() - this.gameOverAt) > 1000;
    txt(ctx, canRestart ? 'Tapnij, aby zagraÄ‡ ponownie' : 'Czekaj...', GW/2, GH*2/3, '15px Arial', canRestart ? '#fff' : '#555');
  },

  onAction(px, py) {
    if (px !== undefined && py !== undefined) {
      if ((this.state === 'waiting' || this.state === 'gameover') && hitLobbyBtn(px, py)) {
        stopSpikesAudio();
        showLobby();
        return;
      }
    }
    if (this.state === 'waiting')  { this.startGame(); return; }
    if (this.state === 'playing')  { this.bird.jump(); return; }
    if (this.state === 'gameover') {
      if (performance.now() - this.gameOverAt > 1000) this.resetState();
      return;
    }
  }
};

// â”€â”€ ModuÅ‚y pomocnicze dla scen (dawne funkcje globalne) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function overlaps(a, b) {
  return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
}
function overlapsSpike(br, spY, side) {
  const w = 24, h = 16;
  if (side === 'left') {
    const tipX = w;
    if (br.x > tipX) return false;
    const penetration = tipX - br.x;
    const allowedY = h * Math.min(1, penetration / w);
    return (br.y <= spY + allowedY && br.y + br.h >= spY - allowedY);
  } else {
    const tipX = GW - w;
    if (br.x + br.w < tipX) return false;
    const penetration = (br.x + br.w) - tipX;
    const allowedY = h * Math.min(1, penetration / w);
    return (br.y <= spY + allowedY && br.y + br.h >= spY - allowedY);
  }
}
// â”€â”€ Optymalizacja Sterownika Graficznego (State Caching) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _ctxFont = '', _ctxFill = '', _ctxAlign = '';

function txt(context, str, x, y, font, color, align = 'center') {
  if (_ctxFont !== font)   { context.font = font;        _ctxFont = font;   }
  if (_ctxFill !== color)  { context.fillStyle = color;  _ctxFill = color;  }
  if (_ctxAlign !== align) { context.textAlign = align;  _ctxAlign = align; }
  context.fillText(str, x, y);
}
function overlay(a) { ctx.fillStyle = `rgba(0,0,0,${a})`; ctx.fillRect(0, 0, GW, GH); }
const SHOP_BTN  = { x: GW - 120, y: GH - 80, w: 110, h: 64 };
const LOBBY_BTN = { x: 10,       y: GH - 80, w: 110, h: 64 };

function hitShopBtn(px, py) {
  const b = SHOP_BTN;
  return px >= b.x && px <= b.x + b.w && py >= b.y && py <= b.y + b.h;
}

function hitLobbyBtn(px, py) {
  const b = LOBBY_BTN;
  return px >= b.x && px <= b.x + b.w && py >= b.y && py <= b.y + b.h;
}

function drawBirdAt(x, y, angle) {
  if (!playerImg) return;
  ctx.save();
  ctx.translate(x + BIRD_SIZE/2, y + BIRD_SIZE/2);
  ctx.rotate(angle * Math.PI / 180);
  ctx.drawImage(playerImg, -BIRD_SIZE/2, -BIRD_SIZE/2, BIRD_SIZE, BIRD_SIZE);
  ctx.restore();
}

let shopFromWaiting = false;
function showShopFromWaiting() { shopFromWaiting = true; showShop(); }

// â”€â”€ Input Delegator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function canvasXY(e) {
  const cx = (e.clientX ?? e.touches?.[0]?.clientX ?? 0) - canvasRect.left;
  const cy = (e.clientY ?? e.touches?.[0]?.clientY ?? 0) - canvasRect.top;
  _touchPos.x = cx / canvasRect.width * GW;
  _touchPos.y = cy / canvasRect.height * GH;
  return _touchPos;
}

document.addEventListener('keydown', e => {
  if (e.code === 'Space') { e.preventDefault(); SceneManager.onAction(); }
});

canvas.addEventListener('pointerdown', e => {
  if (e.pointerType === 'mouse' && e.button !== 0) return;
  e.preventDefault();
  const p = canvasXY(e);
  SceneManager.onAction(p.x, p.y);
});

// â”€â”€ Game loop (starts once, runs forever) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastTime = performance.now(), loopRunning = false;

function loop(now) {
  if (!loopRunning) return;
  requestAnimationFrame(loop);
  let dt = now - lastTime;
  lastTime = now;
  if (dt > 50) dt = 50;
  if (isGameCanvasVisible) {
    SceneManager.update(dt);
    SceneManager.draw();
  }
}

function startGameLoop() {
  if (loopRunning) return;
  loopRunning = true;
  lastTime = performance.now();
  requestAnimationFrame(loop);
}

document.addEventListener('visibilitychange', () => {
  lastTime = performance.now();
  if (document.hidden) {
    if (audioCtx.state === 'running') audioCtx.suspend();
    stopMusic();
    stopSpikesAudio();
  } else {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    if (SceneManager.activeScene && SceneManager.activeScene.state === 'playing') {
      if (SceneManager.activeScene === FlappyMode) resumeMusic();
      else if (SceneManager.activeScene === SpikesMode) resumeSpikesAudio();
    }
  }
});

// â”€â”€ Audio prewarm â€” unlock AudioContext on first user gesture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let audioUnlocked = false;
function unlockAudioOnFirstTouch() {
  if (audioUnlocked) return;
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const silence = new Audio();
  silence.src = 'data:audio/mp3;base64,//OExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq';
  silence.play().catch(() => {});
  audioUnlocked = true;
}
document.addEventListener('touchstart', unlockAudioOnFirstTouch, { once: true });
document.addEventListener('mousedown',  unlockAudioOnFirstTouch, { once: true });

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('Service Worker zarejestrowany.', reg.scope))
      .catch(err => console.warn('Rejestracja Service Workera nie powiodÅ‚a siÄ™:', err));
  });
}
</script>
</body>
</html>
